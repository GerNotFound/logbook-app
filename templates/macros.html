{% extends 'layout.html' %}
{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">LOGBOOK - MACROS</h1>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>
</div>

<div class="mb-4 p-3 border rounded">
    <h5>Impostazioni Macro</h5>
    <p class="text-muted">Calcoli basati sull'ultimo peso registrato: <strong>{{ latest_weight | round(1) if latest_weight > 0 else 'N/A' }} kg</strong></p>
    <form id="macros-form" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="row align-items-center mb-3">
            <div class="col-5">
                <label for="days_on" class="form-label mb-0 text-center d-block">GIORNI ON</label>
                <input type="number" id="days_on" name="days_on" class="form-control text-center" value="{{ targets.days_on }}" min="0" max="7">
            </div>
            <div class="col-2 text-center text-xl">+</div>
            <div class="col-5">
                <label for="days_off" class="form-label mb-0 text-center d-block">GIORNI OFF</label>
                <input type="number" id="days_off" name="days_off" class="form-control text-center" value="{{ targets.days_off }}" min="0" max="7">
            </div>
        </div>
        <hr class="my-4">
        <h6>Giorno ON <small class="text-muted">(g/kg)</small></h6>
        <div class="row g-2">
            <div class="col-4">
                <label class="form-label label-sm">Proteine</label>
                <input type="number" step="0.01" name="p_on" class="form-control" value="{{ targets.p_on }}">
            </div>
            <div class="col-4">
                <label class="form-label label-sm">Carboidrati</label>
                <input type="number" step="0.01" name="c_on" class="form-control" value="{{ targets.c_on }}">
            </div>
            <div class="col-4">
                <label class="form-label label-sm">Grassi</label>
                <input type="number" step="0.01" name="f_on" class="form-control" value="{{ targets.f_on }}">
            </div>
        </div>
        <hr class="my-4">
        <h6>Giorno OFF <small class="text-muted">(g/kg)</small></h6>
        <div class="row g-2">
            <div class="col-4">
                <label class="form-label label-sm">Proteine</label>
                <input type="number" step="0.01" name="p_off" class="form-control" value="{{ targets.p_off }}">
            </div>
            <div class="col-4">
                <label class="form-label label-sm">Carboidrati</label>
                <input type="number" step="0.01" name="c_off" class="form-control" value="{{ targets.c_off }}">
            </div>
            <div class="col-4">
                <label class="form-label label-sm">Grassi</label>
                <input type="number" step="0.01" name="f_off" class="form-control" value="{{ targets.f_off }}">
            </div>
        </div>
    </form>
</div>

{% if latest_weight > 0 %}
<div class="mb-4">
    <h4>Riepilogo Calcoli</h4>
    <div class="row">
        <div class="col-md-6"><div class="p-3 border rounded mb-3"><h5>Giorno ON</h5><p class="mb-1">Proteine: <strong>{{ calcs.p_on_g | round(1) }}g</strong></p><p class="mb-1">Carboidrati: <strong>{{ calcs.c_on_g | round(1) }}g</strong></p><p class="mb-1">Grassi: <strong>{{ calcs.f_on_g | round(1) }}g</strong></p><hr><p class="mb-0">Calorie totali: <strong>{{ calcs.cal_on | round(0) }} kcal</strong></p></div></div>
        <div class="col-md-6"><div class="p-3 border rounded mb-3"><h5>Giorno OFF</h5><p class="mb-1">Proteine: <strong>{{ calcs.p_off_g | round(1) }}g</strong></p><p class="mb-1">Carboidrati: <strong>{{ calcs.c_off_g | round(1) }}g</strong></p><p class="mb-1">Grassi: <strong>{{ calcs.f_off_g | round(1) }}g</strong></p><hr><p class="mb-0">Calorie totali: <strong>{{ calcs.cal_off | round(0) }} kcal</strong></p></div></div>
    </div>
    <div class="p-3 border rounded">
        <h5>Settimanale</h5>
        <p class="mb-1">Calorie totali: <strong>{{ calcs.weekly_cal | round(0) }} kcal</strong></p>
        <p class="mb-1">Calorie giornaliere medie: <strong>{{ calcs.avg_daily_cal | round(0) }} kcal</strong></p>
        <hr>
        <p class="mb-0">Rapporto C/G: <strong>{{ calcs.cg_ratio | round(2) }}</strong></p>
    </div>
</div>
{% else %}
<div class="text-center p-3 border rounded">
    <p class="text-muted">Per visualizzare il riepilogo dei calcoli, inserisci almeno un valore per il tuo peso.</p>
    <a href="{{ url_for('main.misure') }}" class="btn btn-custom btn-custom-tight w-100">VAI A MISURE</a>
</div>
{% endif %}

<div class="sticky-bottom-nav">
    <button type="submit" form="macros-form" class="btn btn-custom action-btn">SALVA</button>
    <a href="{{ url_for('nutrition.alimentazione') }}" class="btn btn-custom action-btn">INDIETRO</a>
</div>
{% endblock %}