{% extends 'layout.html' %}
{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4 brand-heading"><span class="logbook-brand brand-heading__brand">LOGBOOK</span><span class="brand-heading__section">/ MISURE</span></h1>
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <a href="{{ url_for('main.misure', date_str=prev_day) }}" class="btn btn-outline-light">
                <i class="bi bi-chevron-left me-1" aria-hidden="true"></i>
                Prec.
            </a>
            <span class="text-center">
                <h5 class="mb-0 d-inline-block align-middle">{{ date_formatted }}</h5>
                {% if not is_today %}
                    <a href="{{ url_for('main.misure') }}" class="btn btn-sm btn-outline-secondary ms-2">Oggi</a>
                {% endif %}
            </span>
            <a href="{{ url_for('main.misure', date_str=next_day) }}" class="btn btn-outline-light {% if is_today %}disabled{% endif %}">
                Succ.
                <i class="bi bi-chevron-right ms-1" aria-hidden="true"></i>
            </a>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>
</div>

<form id="misure-form" method="POST" action="{{ url_for('main.misure', date_str=current_date_str) }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <div class="row">
        <div class="col-6">
            <label for="weight" class="form-label label-tall">Peso (kg)</label>
            <input type="number" step="0.1" min="0" name="weight" id="weight" class="form-control" value="{{ misure.weight or '' }}">
        </div>
        <div class="col-6">
            <label for="weight_time" class="form-label label-tall">Orario Peso</label>
            <input type="text" name="weight_time" id="weight_time" class="form-control" value="{{ misure.weight_time or '' }}" placeholder="HH:MM">
        </div>
    </div>

    <hr>

    <div class="row">
        <div class="col-6">
            <label for="sleep" class="form-label label-tall">Sonno</label>
            <input type="text" name="sleep" id="sleep" class="form-control" value="{{ misure.sleep or '' }}" placeholder="ore:min">
        </div>
        <div class="col-6">
            <label for="sleep_quality" class="form-label label-tall">Qualit√† Sonno</label>
            <input type="number" min="1" max="10" step="1" name="sleep_quality" id="sleep_quality" class="form-control" value="{{ misure.sleep_quality or '' }}" placeholder="1-10">
        </div>
    </div>
    
    <hr>

    <div class="mb-3">
        <label class="form-label">Calcolo BFP</label>
        <select id="bfp-mode-selector" name="bfp-mode-selector" class="form-select form-control">
            <option value="manual" {% if bfp_mode == 'manual' %}selected{% endif %}>Inserisci Manualmente</option>
            <option value="formula" {% if bfp_mode != 'manual' %}selected{% endif %}>Calcola con Formula</option>
        </select>
    </div>

    <div id="bfp-manual-group" class="{% if bfp_mode != 'manual' %}d-none{% endif %}"{% if bfp_mode != 'manual' %} hidden aria-hidden="true"{% else %} aria-hidden="false"{% endif %}>
        <label for="bfp_manual" class="form-label">BFP (%)</label>
        <input type="number" step="0.1" min="0" name="bfp_manual" id="bfp_manual" class="form-control" value="{{ misure.bfp_manual or '' }}" placeholder="Es. 12.5">
    </div>

    <div id="bfp-formula-group" class="{% if bfp_mode == 'manual' %}d-none{% endif %}"{% if bfp_mode == 'manual' %} hidden aria-hidden="true"{% else %} aria-hidden="false"{% endif %}>
        <div class="row">
            <div class="col-4">
                <label for="neck" class="form-label label-tall">Collo (cm)</label>
                <input type="number" step="0.1" min="0" name="neck" id="neck" class="form-control" value="{{ misure.neck or '' }}">
            </div>
            <div class="col-4">
                <label for="waist" class="form-label label-tall">Vita (cm)</label>
                <input type="number" step="0.1" min="0" name="waist" id="waist" class="form-control" value="{{ misure.waist or '' }}">
            </div>
            {% if gender == 'F' %}
            <div class="col-4" id="hip-container">
                <label for="hip" class="form-label label-tall">Fianchi (cm)</label>
                <input type="number" step="0.1" min="0" name="hip" id="hip" class="form-control" value="{{ misure.hip or '' }}">
            </div>
            {% endif %}
        </div>
        <div class="mb-3">
            <label for="measure_time" class="form-label label-tall">Orario Misure</label>
            <input type="text" name="measure_time" id="measure_time" class="form-control" value="{{ misure.measure_time or '' }}" placeholder="HH:MM">
        </div>
    </div>
</form>

<div class="sticky-bottom-nav">
    <button type="submit" form="misure-form" class="btn btn-custom action-btn">SALVA</button>
    <a href="{{ url_for('main.home') }}" class="btn btn-custom action-btn">INDIETRO</a>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ csp_nonce() }}">
    document.addEventListener('DOMContentLoaded', function() {
        const bfpModeSelector = document.getElementById('bfp-mode-selector');
        const manualGroup = document.getElementById('bfp-manual-group');
        const formulaGroup = document.getElementById('bfp-formula-group');
        let applyBfpMode = () => {};

        if (bfpModeSelector && manualGroup && formulaGroup) {
            const manualInputs = Array.from(manualGroup.querySelectorAll('input'));
            const formulaInputs = Array.from(formulaGroup.querySelectorAll('input'));

            applyBfpMode = function() {
                const isManual = (bfpModeSelector.value || '').toLowerCase() === 'manual';
                manualGroup.classList.toggle('d-none', !isManual);
                formulaGroup.classList.toggle('d-none', isManual);
                if (isManual) {
                    manualGroup.removeAttribute('hidden');
                    manualGroup.setAttribute('aria-hidden', 'false');
                    formulaGroup.setAttribute('hidden', 'hidden');
                    formulaGroup.setAttribute('aria-hidden', 'true');
                } else {
                    manualGroup.setAttribute('hidden', 'hidden');
                    manualGroup.setAttribute('aria-hidden', 'true');
                    formulaGroup.removeAttribute('hidden');
                    formulaGroup.setAttribute('aria-hidden', 'false');
                }
                manualInputs.forEach(input => {
                    input.disabled = !isManual;
                    input.setAttribute('aria-hidden', (!isManual).toString());
                });
                formulaInputs.forEach(input => {
                    input.disabled = isManual;
                    input.setAttribute('aria-hidden', isManual.toString());
                });
            };

            ['change', 'input'].forEach(eventName => {
                bfpModeSelector.addEventListener(eventName, applyBfpMode);
            });

            applyBfpMode();
        }
        
        const DRAFT_KEY_MEASURES = `measures_draft_{{ session['user_id'] }}_{{ current_date_str }}`;
        const measuresForm = document.getElementById('misure-form');
        const measuresInputs = measuresForm.querySelectorAll('input, select');
        
        function saveMeasuresDraft() {
            const draftData = {};
            measuresInputs.forEach(input => { if (input.value && input.name) draftData[input.name] = input.value; });
            localStorage.setItem(DRAFT_KEY_MEASURES, JSON.stringify(draftData));
        }

        function loadMeasuresDraft() {
            const draft = localStorage.getItem(DRAFT_KEY_MEASURES);
            if (draft) {
                const draftData = JSON.parse(draft);
                measuresInputs.forEach(input => {
                    if (draftData[input.name] && !input.disabled) {
                        input.value = draftData[input.name];
                    }
                });
            }
            applyBfpMode();
        }

        measuresInputs.forEach(input => input.addEventListener('input', saveMeasuresDraft));
        measuresForm.addEventListener('submit', () => localStorage.removeItem(DRAFT_KEY_MEASURES));

        loadMeasuresDraft();
    });
</script>
{% endblock %}
