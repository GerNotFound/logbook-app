{% extends 'layout.html' %}
{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4 brand-heading"><span class="logbook-brand brand-heading__brand">LOGBOOK</span><span class="brand-heading__section">/ MODIFICA SCHEDA</span></h1>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">{{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>
</div>

<div id="template-editor-container">
    <form id="edit-template-form" method="POST" action="{{ url_for('gym.modifica_scheda_dettaglio', template_id=template.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">{{ template.name }}</h4>
            <button type="button" class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#renameTemplateModal">Rinomina</button>
        </div>

        <div class="mb-4">
            <h5>Esercizi</h5>
            <div class="table-responsive">
                <table class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th class="text-center" style="width: 50px;">Ordina</th>
                            <th>Esercizio</th>
                            <th class="serie-column">Serie</th>
                            <th class="text-center">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="current-exercises-tbody">
                        {% for exercise in current_exercises %}
                        <tr data-exercise-id="{{ exercise.exercise_id }}">
                            <td class="text-center align-middle sort-handle" style="cursor: grab;"><i class="bi bi-grip-vertical"></i></td>
                            <td class="align-middle exercise-name-cell">{{ exercise.name }}</td>
                            <td class="align-middle">
                                <input type="text" class="form-control form-control-sm" name="sets_{{ exercise.exercise_id }}" value="{{ exercise.sets }}">
                            </td>
                            <td class="text-center align-middle">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-outline-light move-up" title="Sposta su"><i class="bi bi-arrow-up"></i></button>
                                    <button type="button" class="btn btn-sm btn-outline-light move-down" title="Sposta giù"><i class="bi bi-arrow-down"></i></button>
                                    <button type="button" class="btn btn-sm btn-delete remove-exercise" title="Rimuovi Esercizio"><i class="bi bi-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <p id="no-exercises-placeholder" class="text-center text-muted {% if current_exercises %}d-none{% endif %}">Nessun esercizio in questa scheda.</p>
            </div>
        </div>
    </form>

    <div id="all-exercises-list" class="mb-4">
        <h5>Cerca Esercizio</h5>
        <input type="text" class="form-control search" placeholder="Digita per filtrare gli esercizi...">
        
        <div class="table-responsive mt-3" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-bordered table-hover table-sm">
                <thead>
                    <tr>
                        <th>Esercizio</th>
                        <th class="text-center">Azioni</th>
                    </tr>
                </thead>
                <tbody class="list">
                    {% for exercise in all_exercises %}
                    <tr data-id="{{ exercise.id }}" data-is-global="{{ 1 if exercise.user_id is none else 0 }}">
                        <td class="exercise-name-cell">{{ exercise.name }} {% if exercise.user_id is none %}<i class="bi bi-globe2 global-icon" title="Esercizio globale"></i>{% endif %}</td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-outline-light add-exercise">Aggiungi</button>
                            <a href="{{ url_for('gym.esercizio_info', exercise_id=exercise.id) }}" class="btn btn-sm btn-outline-secondary">Info</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="renameTemplateModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Rinomina Scheda</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <label for="new_template_name" class="form-label">Nuovo nome</label>
                    <input type="text" name="new_template_name" id="new_template_name" class="form-control" value="{{ template.name }}" required form="edit-template-form">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-custom btn-custom-tight m-0" data-bs-dismiss="modal">Conferma</button>
                </div>
            </div>
        </div>
    </div>

    <div class="sticky-bottom-nav">
        <button type="submit" form="edit-template-form" class="btn btn-custom action-btn">SALVA</button>
        <a id="cancel-button" href="{{ url_for('gym.scheda') }}" class="btn btn-custom action-btn">INDIETRO</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Librerie Specializzate -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script nonce="{{ csp_nonce() }}">
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('edit-template-form');
        const currentExercisesTbody = document.getElementById('current-exercises-tbody');
        const noExercisesPlaceholder = document.getElementById('no-exercises-placeholder');
        const cancelButton = document.getElementById('cancel-button');
        let isDirty = false;

        // --- STATO INIZIALE ---
        function getInitialState() {
            const exerciseOrder = Array.from(currentExercisesTbody.querySelectorAll('tr')).map(tr => {
                const id = tr.dataset.exerciseId;
                const sets = tr.querySelector(`input[name="sets_${id}"]`).value;
                return `${id}:${sets}`;
            }).join(',');
            const templateName = document.getElementById('new_template_name').value;
            return `${templateName}|${exerciseOrder}`;
        }
        const initialState = getInitialState();

        function setDirty() {
            isDirty = true;
            cancelButton.textContent = 'ANNULLA';
        }

        // --- 1. LIBRERIA PER LA RICERCA: List.js ---
        const exerciseList = new List('all-exercises-list', {
            valueNames: ['exercise-name-cell']
        });

        // --- 2. LIBRERIA PER L'ORDINAMENTO: SortableJS ---
        const sortable = new Sortable(currentExercisesTbody, {
            animation: 150,
            handle: '.sort-handle',
            onEnd: setDirty
        });

        // --- 3. LOGICA DI INTERAZIONE (AGGIUNGI, RIMUOVI, SPOSTA) ---
        function updateEventListeners(container) {
            container.querySelectorAll('.remove-exercise').forEach(button => {
                button.onclick = function() {
                    this.closest('tr').remove();
                    updatePlaceholder();
                    setDirty();
                };
            });
            container.querySelectorAll('.move-up').forEach(button => {
                button.onclick = function() {
                    const row = this.closest('tr');
                    const prevRow = row.previousElementSibling;
                    if (prevRow) {
                        currentExercisesTbody.insertBefore(row, prevRow);
                        setDirty();
                    }
                };
            });
            container.querySelectorAll('.move-down').forEach(button => {
                button.onclick = function() {
                    const row = this.closest('tr');
                    const nextRow = row.nextElementSibling;
                    if (nextRow) {
                        currentExercisesTbody.insertBefore(nextRow, row);
                        setDirty();
                    }
                };
            });
        }

        function updatePlaceholder() {
            noExercisesPlaceholder.classList.toggle('d-none', currentExercisesTbody.children.length > 0);
        }

        document.getElementById('all-exercises-list').addEventListener('click', function(e) {
            if (e.target.classList.contains('add-exercise')) {
                const rowToAdd = e.target.closest('tr');
                const exerciseId = rowToAdd.dataset.id;
                const exerciseName = rowToAdd.querySelector('.exercise-name-cell').textContent.trim();

                if (currentExercisesTbody.querySelector(`tr[data-exercise-id="${exerciseId}"]`)) {
                    alert("Questo esercizio è già nella scheda.");
                    return;
                }

                const newRow = document.createElement('tr');
                newRow.dataset.exerciseId = exerciseId;
                newRow.innerHTML = `
                    <td class="text-center align-middle sort-handle" style="cursor: grab;"><i class="bi bi-grip-vertical"></i></td>
                    <td class="align-middle exercise-name-cell">${exerciseName}</td>
                    <td class="align-middle">
                        <input type="text" class="form-control form-control-sm" name="sets_${exerciseId}" value="1">
                    </td>
                    <td class="text-center align-middle">
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-light move-up" title="Sposta su"><i class="bi bi-arrow-up"></i></button>
                            <button type="button" class="btn btn-sm btn-outline-light move-down" title="Sposta giù"><i class="bi bi-arrow-down"></i></button>
                            <button type="button" class="btn btn-sm btn-delete remove-exercise" title="Rimuovi Esercizio"><i class="bi bi-trash"></i></button>
                        </div>
                    </td>
                `;
                currentExercisesTbody.appendChild(newRow);
                updateEventListeners(newRow);
                updatePlaceholder();
                setDirty();
            }
        });

        // --- 4. GESTIONE DEL SALVATAGGIO E DELLO STATO "DIRTY" ---
        form.addEventListener('input', () => {
            const currentState = getInitialState();
            if (currentState !== initialState) {
                setDirty();
            }
        });

        form.addEventListener('submit', function(e) {
            // Prima di inviare, crea gli input nascosti con l'ordine corretto
            const existingOrderInputs = form.querySelectorAll('input[name="exercise_id"]');
            existingOrderInputs.forEach(input => input.remove());

            const rows = currentExercisesTbody.querySelectorAll('tr');
            rows.forEach(row => {
                const exerciseId = row.dataset.exerciseId;
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'exercise_id';
                input.value = exerciseId;
                form.appendChild(input);
            });
        });

        // Inizializza gli event listener per gli elementi già presenti
        updateEventListeners(currentExercisesTbody);
    });
</script>
{% endblock %}