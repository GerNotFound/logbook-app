{% extends 'layout.html' %}
{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4 brand-heading"><span class="logbook-brand brand-heading__brand">LOGBOOK</span><span class="brand-heading__section">/ {{ template.name }}</span></h1>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">{{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>
</div>

<div class="mb-4">
    <h5>Esercizi Attuali</h5>
    <table class="table table-sm table-bordered">
        <thead>
            <tr>
                <th>Esercizio</th>
                <th class="serie-column">Serie</th>
                <th class="text-center">Azioni</th>
            </tr>
        </thead>
        <tbody id="current-exercises-tbody">
            {% for exercise in current_exercises %}
            <tr id="template-exercise-row-{{ exercise.id }}" data-template-exercise-id="{{ exercise.id }}">
                <td class="align-middle">{{ exercise.name }}</td>
                <td class="align-middle">
                    <form class="update-sets-form" id="update-sets-form-{{ exercise.id }}" method="POST" action="{{ url_for('gym.modifica_scheda_dettaglio', template_slug=template_slug) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="action" value="update_sets">
                        <input type="hidden" name="template_exercise_id" value="{{ exercise.id }}">
                        <input type="text" class="form-control form-control-sm" name="sets" value="{{ exercise.sets }}">
                    </form>
                </td>
                <td class="text-center align-middle">
                    <div class="d-flex justify-content-center align-items-center gap-2 flex-wrap">
                        <div class="btn-group" role="group" aria-label="Riordina esercizio">
                            <button type="button" class="btn btn-sm btn-outline-secondary move-exercise-button" data-direction="up" data-template-exercise-id="{{ exercise.id }}" title="Sposta su" {% if loop.first %}disabled{% endif %}>
                                <i class="bi bi-arrow-up"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary move-exercise-button" data-direction="down" data-template-exercise-id="{{ exercise.id }}" title="Sposta giÃ¹" {% if loop.last %}disabled{% endif %}>
                                <i class="bi bi-arrow-down"></i>
                            </button>
                        </div>
                        <button type="submit" form="update-sets-form-{{ exercise.id }}" class="btn btn-sm btn-outline-light" title="Salva Serie"><i class="bi bi-floppy"></i></button>
                        <form method="POST" action="{{ url_for('gym.modifica_scheda_dettaglio', template_slug=template_slug) }}" onsubmit="return confirm('Confermi di voler eliminare questo esercizio dalla scheda?');" class="d-inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" value="delete_template_exercise">
                            <input type="hidden" name="template_exercise_id" value="{{ exercise.id }}">
                            <button type="submit" class="btn btn-sm btn-delete" title="Elimina Esercizio"><i class="bi bi-trash"></i></button>
                        </form>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr><td colspan="3" class="text-center text-muted">Nessun esercizio in questa scheda.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="mb-4">
    <div class="row g-3 align-items-end">
        <div class="col-md-8 col-lg-6">
            <label for="search-exercise-input" class="form-label">Cerca Esercizio</label>
            <div class="input-group" id="search-exercise-controls">
                <input type="text" id="search-exercise-input" class="form-control" placeholder="Digita per filtrare gli esercizi...">
                <button type="button" class="btn btn-outline-light" id="search-exercise-button">CERCA</button>
            </div>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('gym.esercizi') }}" class="btn btn-custom btn-custom-short">CREA ESERCIZIO</a>
        </div>
    </div>
    <div class="table-responsive mt-3" style="max-height: 400px; overflow-y: auto;">
        <table class="table table-bordered table-hover table-sm">
            <thead>
                <tr>
                    <th>Esercizio</th>
                    <th class="text-center">Azioni</th>
                </tr>
            </thead>
            <tbody id="all-exercises-tbody">
                {% for exercise in all_exercises %}
                <tr class="exercise-row" data-name="{{ exercise.name | lower }}">
                    <td>{{ exercise.name }} {% if exercise.user_id is none %}<i class="bi bi-globe2 global-icon" title="Esercizio globale"></i>{% endif %}</td>
                    <td class="text-center">
                        <form method="POST" action="{{ url_for('gym.modifica_scheda_dettaglio', template_slug=template_slug) }}" class="d-inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" value="add_exercise_to_template">
                            <input type="hidden" name="exercise_id" value="{{ exercise.id }}">
                            <button type="submit" class="btn btn-sm btn-outline-light">Aggiungi</button>
                        </form>
                        <a href="{{ url_for('gym.esercizio_info', exercise_id=exercise.id) }}" class="btn btn-sm btn-outline-secondary">Info</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="sticky-bottom-nav">
    <a href="{{ url_for('gym.scheda') }}" class="btn btn-custom full-width-btn">TORNA ALLE SCHEDE</a>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ csp_nonce() }}">
    document.addEventListener('DOMContentLoaded', function() {
        var searchInput = document.getElementById('search-exercise-input');
        var searchButton = document.getElementById('search-exercise-button');
        var exercisesTbody = document.getElementById('all-exercises-tbody');
        var exerciseRows = exercisesTbody ? Array.prototype.slice.call(exercisesTbody.querySelectorAll('.exercise-row')) : [];

        function applyExerciseFilter() {
            if (!exercisesTbody) {
                return;
            }

            var rawValue = searchInput && typeof searchInput.value === 'string' ? searchInput.value : '';
            var searchTerm = rawValue.toLowerCase().trim();

            if (!searchTerm) {
                for (var i = 0; i < exerciseRows.length; i++) {
                    var row = exerciseRows[i];
                    row.style.display = '';
                    exercisesTbody.appendChild(row);
                }
                return;
            }

            var prefixMatches = [];
            var containsMatches = [];

            for (var j = 0; j < exerciseRows.length; j++) {
                var exerciseRow = exerciseRows[j];
                var datasetName = exerciseRow.getAttribute('data-name') || '';
                if (datasetName.indexOf(searchTerm) === 0) {
                    prefixMatches.push(exerciseRow);
                } else if (datasetName.indexOf(searchTerm) > -1) {
                    containsMatches.push(exerciseRow);
                }
                exerciseRow.style.display = 'none';
            }

            var orderedMatches = prefixMatches.concat(containsMatches);
            for (var k = 0; k < orderedMatches.length; k++) {
                var matchedRow = orderedMatches[k];
                matchedRow.style.display = '';
                exercisesTbody.appendChild(matchedRow);
            }
        }

        if (searchInput) {
            searchInput.addEventListener('input', function() {
                applyExerciseFilter();
            });
            searchInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    applyExerciseFilter();
                }
            });
        }
        if (searchButton) {
            searchButton.addEventListener('click', function(event) {
                event.preventDefault();
                applyExerciseFilter();
            });
        }

        var updateForms = document.querySelectorAll('.update-sets-form');

        async function handleUpdateSets(form, triggerButton) {
            if (!form) {
                return;
            }

            var button = triggerButton || document.querySelector('button[form="' + form.id + '"]');
            var originalIconHTML = button ? button.innerHTML : null;

            if (button) {
                button.disabled = true;
                button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            }

            try {
                var response = await fetch("{{ url_for('gym.aggiorna_serie') }}", {
                    method: 'POST',
                    body: new FormData(form)
                });
                var data = await response.json();
                if (response.ok && data.success) {
                    if (button) {
                        button.innerHTML = '<i class="bi bi-check-lg"></i>';
                    }
                } else {
                    if (button) {
                        button.innerHTML = '<i class="bi bi-x-lg"></i>';
                    }
                    alert(data.error || 'Errore');
                }
            } catch (error) {
                if (button) {
                    button.innerHTML = '<i class="bi bi-x-lg"></i>';
                }
                alert('Errore di rete.');
            } finally {
                if (button) {
                    setTimeout(function() {
                        button.disabled = false;
                        button.innerHTML = originalIconHTML;
                    }, 2000);
                }
            }
        }

        for (var f = 0; f < updateForms.length; f++) {
            (function(form) {
                form.addEventListener('submit', function(event) {
                    event.preventDefault();
                    handleUpdateSets(form);
                });
            })(updateForms[f]);
        }

        var saveButtons = document.querySelectorAll('button[type="submit"][form^="update-sets-form-"]');
        for (var b = 0; b < saveButtons.length; b++) {
            (function(button) {
                button.addEventListener('click', function(event) {
                    event.preventDefault();
                    var formId = button.getAttribute('form');
                    var form = document.getElementById(formId);
                    handleUpdateSets(form, button);
                });
            })(saveButtons[b]);
        }

        var currentExercisesTbody = document.getElementById('current-exercises-tbody');

        function getCsrfToken() {
            var tokenInput = document.querySelector('.update-sets-form input[name="csrf_token"]');
            if (tokenInput) {
                return tokenInput.value;
            }
            var fallbackToken = document.querySelector('input[name="csrf_token"]');
            return fallbackToken ? fallbackToken.value : '';
        }

        function refreshReorderButtons() {
            if (!currentExercisesTbody) {
                return;
            }
            var rows = currentExercisesTbody.querySelectorAll('tr[data-template-exercise-id]');
            var total = rows.length;
            for (var idx = 0; idx < total; idx++) {
                var row = rows[idx];
                var upButton = row.querySelector('.move-exercise-button[data-direction="up"]');
                var downButton = row.querySelector('.move-exercise-button[data-direction="down"]');
                if (upButton) {
                    upButton.disabled = idx === 0;
                }
                if (downButton) {
                    downButton.disabled = idx === total - 1;
                }
            }
        }

        function handleReorderClick(event) {
            event.preventDefault();
            var button = event.currentTarget;
            if (!button || button.disabled) {
                return;
            }

            var templateExerciseId = button.getAttribute('data-template-exercise-id');
            var direction = button.getAttribute('data-direction');
            if (!templateExerciseId || !direction) {
                return;
            }

            var formData = new FormData();
            formData.append('csrf_token', getCsrfToken());
            formData.append('template_exercise_id', templateExerciseId);
            formData.append('direction', direction);

            button.disabled = true;

            fetch("{{ url_for('gym.riordina_esercizio') }}", {
                method: 'POST',
                body: formData
            })
                .then(function(response) {
                    return response
                        .json()
                        .then(function(payload) {
                            return { ok: response.ok, payload: payload };
                        })
                        .catch(function() {
                            return { ok: response.ok, payload: { success: false, error: 'Risposta non valida.' } };
                        });
                })
                .then(function(result) {
                    if (!result.ok || !result.payload || !result.payload.success) {
                        var message = result.payload && result.payload.error ? result.payload.error : 'Impossibile riordinare l\'esercizio.';
                        throw new Error(message);
                    }

                    if (!currentExercisesTbody) {
                        return;
                    }

                    var row = document.getElementById('template-exercise-row-' + templateExerciseId);
                    if (!row) {
                        return;
                    }

                    if (direction === 'up') {
                        var previousRow = row.previousElementSibling;
                        if (previousRow) {
                            currentExercisesTbody.insertBefore(row, previousRow);
                        }
                    } else if (direction === 'down') {
                        var nextRow = row.nextElementSibling;
                        if (nextRow) {
                            currentExercisesTbody.insertBefore(nextRow, row);
                        }
                    }
                })
                .catch(function(error) {
                    alert(error.message || 'Impossibile riordinare l\'esercizio.');
                })
                .finally(function() {
                    button.disabled = false;
                    refreshReorderButtons();
                });
        }

        var reorderButtons = document.querySelectorAll('.move-exercise-button');
        for (var r = 0; r < reorderButtons.length; r++) {
            reorderButtons[r].addEventListener('click', handleReorderClick);
        }

        refreshReorderButtons();
    });
</script>
{% endblock %}
