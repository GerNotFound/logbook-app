{% extends 'layout.html' %}
{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4 brand-heading"><span class="logbook-brand brand-heading__brand">LOGBOOK</span><span class="brand-heading__section">/ MODIFICA SCHEDA</span></h1>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">{{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>
</div>

<form id="edit-template-form" method="POST" action="{{ url_for('gym.modifica_scheda_dettaglio', template_id=template.id) }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">{{ template.name }}</h4>
        <button type="button" class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#renameTemplateModal">Rinomina</button>
    </div>

    <div class="mb-4">
        <h5>Esercizi</h5>
        <div class="table-responsive">
            <table class="table table-sm table-bordered">
                <thead>
                    <tr>
                        <th>Esercizio</th>
                        <th class="serie-column">Serie</th>
                        <th class="text-center">Azioni</th>
                    </tr>
                </thead>
                <tbody id="current-exercises-tbody">
                    {% for exercise in current_exercises %}
                    <tr data-exercise-id="{{ exercise.exercise_id }}">
                        <input type="hidden" name="exercise_id" value="{{ exercise.exercise_id }}">
                        <td class="align-middle exercise-name-cell">{{ exercise.name }}</td>
                        <td class="align-middle">
                            <input type="text" class="form-control form-control-sm" name="sets_{{ exercise.exercise_id }}" value="{{ exercise.sets }}">
                        </td>
                        <td class="text-center align-middle">
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-light move-up" title="Sposta su"><i class="bi bi-arrow-up"></i></button>
                                <button type="button" class="btn btn-sm btn-outline-light move-down" title="Sposta giù"><i class="bi bi-arrow-down"></i></button>
                                <button type="button" class="btn btn-sm btn-delete remove-exercise" title="Rimuovi Esercizio"><i class="bi bi-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <p id="no-exercises-placeholder" class="text-center text-muted {% if current_exercises %}d-none{% endif %}">Nessun esercizio in questa scheda.</p>
        </div>
    </div>
</form>

<div id="all-exercises-list" class="mb-4">
    <h5>Cerca Esercizio</h5>
    <input type="text" class="form-control search" placeholder="Digita per filtrare gli esercizi...">
    <a href="{{ url_for('gym.esercizi') }}" class="btn btn-custom w-100 d-block mt-2">CREA ESERCIZIO</a>
    
    <div class="table-responsive mt-3" style="max-height: 400px; overflow-y: auto;">
        <table class="table table-bordered table-hover table-sm">
            <thead>
                <tr>
                    <th>Esercizio</th>
                    <th class="text-center">Azioni</th>
                </tr>
            </thead>
            <tbody class="list">
                {% for exercise in all_exercises %}
                <tr data-id="{{ exercise.id }}" data-is-global="{{ 1 if exercise.user_id is none else 0 }}">
                    <td class="exercise-name-cell">{{ exercise.name }} {% if exercise.user_id is none %}<i class="bi bi-globe2 global-icon" title="Esercizio globale"></i>{% endif %}</td>
                    <td class="text-center">
                        <button type="button" class="btn btn-sm btn-outline-light add-exercise">Aggiungi</button>
                        <a href="{{ url_for('gym.esercizio_info', exercise_id=exercise.id) }}" class="btn btn-sm btn-outline-secondary">Info</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal per rinominare la scheda -->
<div class="modal fade" id="renameTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Rinomina Scheda</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <label for="new_template_name" class="form-label">Nuovo nome</label>
                <input type="text" name="new_template_name" id="new_template_name" class="form-control" value="{{ template.name }}" required form="edit-template-form">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-custom btn-custom-tight m-0" data-bs-dismiss="modal">Conferma</button>
            </div>
        </div>
    </div>
</div>

<div class="sticky-bottom-nav">
    <button type="submit" form="edit-template-form" class="btn btn-custom action-btn">SALVA</button>
    <a id="cancel-button" href="{{ url_for('gym.scheda') }}" class="btn btn-custom action-btn">INDIETRO</a>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>
<script nonce="{{ csp_nonce() }}">
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('edit-template-form');
        const currentExercisesTbody = document.getElementById('current-exercises-tbody');
        const noExercisesPlaceholder = document.getElementById('no-exercises-placeholder');
        const cancelButton = document.getElementById('cancel-button');
        let isDirty = false;

        // --- Logica per rilevare modifiche e aggiornare il pulsante Annulla ---
        function getFormState() {
            const exerciseOrder = Array.from(currentExercisesTbody.querySelectorAll('tr')).map(tr => {
                const id = tr.dataset.exerciseId;
                const sets = tr.querySelector(`input[name="sets_${id}"]`).value;
                return `${id}:${sets}`;
            }).join(',');
            const templateName = document.getElementById('new_template_name').value;
            return `${templateName}|${exerciseOrder}`;
        }

        const initialState = getFormState();

        function checkDirtyState() {
            const currentState = getFormState();
            isDirty = (currentState !== initialState);
            cancelButton.textContent = isDirty ? 'ANNULLA' : 'INDIETRO';
        }

        form.addEventListener('input', checkDirtyState);
        // Aggiungiamo un listener globale per rilevare aggiunte/rimozioni/riordino
        new MutationObserver(checkDirtyState).observe(currentExercisesTbody, { childList: true, subtree: true });

        // --- Logica Ricerca Live con List.js ---
        const exerciseList = new List('all-exercises-list', {
            valueNames: ['exercise-name-cell']
        });

        // --- Logica Aggiungi Esercizio (Client-Side) ---
        document.getElementById('all-exercises-list').addEventListener('click', function(e) {
            if (e.target.classList.contains('add-exercise')) {
                const rowToAdd = e.target.closest('tr');
                const exerciseId = rowToAdd.dataset.id;
                const exerciseName = rowToAdd.querySelector('.exercise-name-cell').textContent.trim();

                if (currentExercisesTbody.querySelector(`tr[data-exercise-id="${exerciseId}"]`)) {
                    alert("Questo esercizio è già nella scheda.");
                    return;
                }

                const newRow = document.createElement('tr');
                newRow.dataset.exerciseId = exerciseId;
                newRow.innerHTML = `
                    <input type="hidden" name="exercise_id" value="${exerciseId}">
                    <td class="align-middle exercise-name-cell">${exerciseName}</td>
                    <td class="align-middle">
                        <input type="text" class="form-control form-control-sm" name="sets_${exerciseId}" value="1">
                    </td>
                    <td class="text-center align-middle">
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-light move-up" title="Sposta su"><i class="bi bi-arrow-up"></i></button>
                            <button type="button" class="btn btn-sm btn-outline-light move-down" title="Sposta giù"><i class="bi bi-arrow-down"></i></button>
                            <button type="button" class="btn btn-sm btn-delete remove-exercise" title="Rimuovi Esercizio"><i class="bi bi-trash"></i></button>
                        </div>
                    </td>
                `;
                currentExercisesTbody.appendChild(newRow);
                updateEventListenersForRow(newRow);
                checkDirtyState();
            }
        });

        function updateEventListenersForRow(row) {
            // Rimuovi esercizio
            row.querySelector('.remove-exercise').addEventListener('click', function() {
                this.closest('tr').remove();
                checkDirtyState();
            });
            // Sposta su
            row.querySelector('.move-up').addEventListener('click', function() {
                const currentRow = this.closest('tr');
                const prevRow = currentRow.previousElementSibling;
                if (prevRow) {
                    currentExercisesTbody.insertBefore(currentRow, prevRow);
                    checkDirtyState();
                }
            });
            // Sposta giù
            row.querySelector('.move-down').addEventListener('click', function() {
                const currentRow = this.closest('tr');
                const nextRow = currentRow.nextElementSibling;
                if (nextRow) {
                    currentExercisesTbody.insertBefore(nextRow, currentRow);
                    checkDirtyState();
                }
            });
            // Aggiorna placeholder
            noExercisesPlaceholder.classList.toggle('d-none', currentExercisesTbody.children.length > 0);
        }
        
        // Inizializza gli event listener per le righe esistenti al caricamento
        currentExercisesTbody.querySelectorAll('tr').forEach(updateEventListenersForRow);
    });
</script>
{% endblock %}