{% extends 'layout.html' %}
{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4 brand-heading"><span class="logbook-brand brand-heading__brand">LOGBOOK</span><span class="brand-heading__section">/ {{ template.name }}</span></h1>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">{{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>
</div>

<form id="template-edit-form" method="POST" action="{{ url_for('gym.modifica_scheda_dettaglio', template_slug=template_slug) }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="action" value="save_template_changes">
    <input type="hidden" name="state_payload" id="state-payload">

    <div class="mb-4">
        <h5>Esercizi Attuali</h5>
        <table class="table table-sm table-bordered">
        <thead>
            <tr>
                <th class="text-center position-column">#</th>
                <th>Esercizio</th>
                <th class="serie-column">Serie</th>
                <th class="text-center">Azioni</th>
            </tr>
        </thead>
        <tbody id="current-exercises-tbody">
            {% for exercise in current_exercises %}
            <tr class="template-exercise-row" data-template-exercise-id="{{ exercise.id }}">
                <td class="text-center align-middle position-cell"><span class="exercise-position"></span></td>
                <td class="align-middle">{{ exercise.name }}</td>
                <td class="align-middle">
                    <input type="text" class="form-control form-control-sm sets-input" value="{{ exercise.sets }}">
                </td>
                <td class="text-center align-middle">
                    <div class="d-flex justify-content-center align-items-center gap-2 flex-wrap">
                        <div class="reorder-controls d-flex flex-column align-items-stretch gap-1" aria-label="Riordina esercizio">
                            <button type="button" class="btn btn-sm btn-outline-secondary move-exercise-button" data-direction="up" title="Sposta su">
                                <i class="bi bi-arrow-up"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary move-exercise-button" data-direction="down" title="Sposta giÃ¹">
                                <i class="bi bi-arrow-down"></i>
                            </button>
                        </div>
                        <button type="button" class="btn btn-sm btn-delete remove-exercise-button" title="Rimuovi esercizio">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
            <tr id="no-exercises-row" class="{% if current_exercises %}d-none{% endif %}">
                <td colspan="4" class="text-center text-muted">Nessun esercizio in questa scheda.</td>
            </tr>
        </tbody>
        </table>
    </div>

    <div class="mb-4">
        <div class="row g-3 align-items-end">
            <div class="col-md-8 col-lg-6">
                <label for="search-exercise-input" class="form-label">Cerca Esercizio</label>
                <div class="input-group" id="search-exercise-controls">
                    <input type="text" id="search-exercise-input" class="form-control" placeholder="Digita per filtrare gli esercizi...">
                    <button type="button" class="btn btn-outline-light" id="search-exercise-button">CERCA</button>
                </div>
            </div>
            <div class="col-auto">
                <a href="{{ url_for('gym.esercizi') }}" class="btn btn-custom btn-custom-short">CREA ESERCIZIO</a>
            </div>
        </div>
        <div class="table-responsive mt-3" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-bordered table-hover table-sm">
                <thead>
                    <tr>
                        <th>Esercizio</th>
                        <th class="text-center">Azioni</th>
                    </tr>
                </thead>
                <tbody id="all-exercises-tbody">
                    {% for exercise in all_exercises %}
                    <tr class="exercise-row" data-name="{{ exercise.name | lower }}" data-exercise-id="{{ exercise.id }}" data-exercise-name="{{ exercise.name | e }}" data-is-global="{{ 1 if exercise.user_id is none else 0 }}">
                        <td>{{ exercise.name }} {% if exercise.user_id is none %}<i class="bi bi-globe2 global-icon" title="Esercizio globale"></i>{% endif %}</td>
                        <td class="text-center">
                            <div class="d-inline-flex gap-2">
                                <button type="button" class="btn btn-sm btn-outline-light add-exercise-button" title="Aggiungi esercizio">
                                    <i class="bi bi-plus"></i>
                                </button>
                                <a href="{{ url_for('gym.esercizio_info', exercise_id=exercise.id) }}" class="btn btn-sm btn-outline-secondary">Info</a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</form>

<div class="sticky-bottom-nav">
    <button type="submit" class="btn btn-custom action-btn" form="template-edit-form" id="save-template-button">SALVA</button>
    <a id="cancel-changes-button" class="btn btn-custom action-btn" href="{{ cancel_url or url_for('gym.scheda') }}">ANNULLA</a>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ csp_nonce() }}">
    document.addEventListener('DOMContentLoaded', function() {
        var searchInput = document.getElementById('search-exercise-input');
        var searchButton = document.getElementById('search-exercise-button');
        var exercisesTbody = document.getElementById('all-exercises-tbody');
        var allExerciseRows = [];
        var noExerciseResultsRow = null;
        var currentExercisesTbody = document.getElementById('current-exercises-tbody');
        var emptyStateRow = document.getElementById('no-exercises-row');
        var templateForm = document.getElementById('template-edit-form');
        var stateInput = document.getElementById('state-payload');
        var cancelButton = document.getElementById('cancel-changes-button');
        var saveButton = document.getElementById('save-template-button');
        var deletedExercises = [];
        var formSubmitting = false;

        function addDeletedExercise(id) {
            if (!id) {
                return;
            }
            if (deletedExercises.indexOf(id) === -1) {
                deletedExercises.push(id);
            }
        }

        function getExerciseRows() {
            if (!currentExercisesTbody) {
                return [];
            }
            return Array.prototype.slice.call(currentExercisesTbody.querySelectorAll('tr[data-template-exercise-id], tr[data-new-exercise-id]'));
        }

        function updateEmptyState() {
            if (!emptyStateRow) {
                return;
            }
            var rows = getExerciseRows();
            if (rows.length === 0) {
                emptyStateRow.classList.remove('d-none');
            } else {
                emptyStateRow.classList.add('d-none');
            }
        }

        function refreshReorderButtons() {
            var rows = getExerciseRows();
            for (var idx = 0; idx < rows.length; idx++) {
                var row = rows[idx];
                var upButton = row.querySelector('.move-exercise-button[data-direction="up"]');
                var downButton = row.querySelector('.move-exercise-button[data-direction="down"]');
                if (upButton) {
                    upButton.disabled = idx === 0;
                }
                if (downButton) {
                    downButton.disabled = idx === rows.length - 1;
                }
            }
        }

        function updateExercisePositions() {
            var rows = getExerciseRows();
            for (var idx = 0; idx < rows.length; idx++) {
                var cell = rows[idx].querySelector('.exercise-position');
                if (cell) {
                    cell.textContent = String(idx + 1);
                }
            }
        }

        function moveRow(row, direction) {
            if (!row || !currentExercisesTbody) {
                return;
            }
            var rows = getExerciseRows();
            var index = rows.indexOf(row);
            if (index === -1) {
                return;
            }
            if (direction === 'up' && index > 0) {
                var previousRow = rows[index - 1];
                currentExercisesTbody.insertBefore(row, previousRow);
            } else if (direction === 'down' && index < rows.length - 1) {
                var nextRow = rows[index + 1];
                var referenceNode = nextRow.nextSibling;
                if (referenceNode) {
                    currentExercisesTbody.insertBefore(row, referenceNode);
                } else if (emptyStateRow && emptyStateRow.parentNode === currentExercisesTbody) {
                    currentExercisesTbody.insertBefore(row, emptyStateRow);
                } else {
                    currentExercisesTbody.appendChild(row);
                }
            }
            refreshReorderButtons();
            updateExercisePositions();
        }

        function handleRemoveRow(row) {
            if (!row) {
                return;
            }
            var templateExerciseId = row.getAttribute('data-template-exercise-id');
            var confirmMessage = templateExerciseId ? 'Confermi di voler rimuovere questo esercizio dalla scheda? Le modifiche saranno applicate solo dopo aver salvato.' : 'Confermi di voler rimuovere questo esercizio appena aggiunto?';
            if (!window.confirm(confirmMessage)) {
                return;
            }
            if (templateExerciseId) {
                addDeletedExercise(templateExerciseId);
            }
            row.remove();
            updateEmptyState();
            refreshReorderButtons();
            updateExercisePositions();
        }

        function attachRowEvents(row) {
            if (!row) {
                return;
            }
            var moveButtons = row.querySelectorAll('.move-exercise-button');
            for (var i = 0; i < moveButtons.length; i++) {
                (function(button, currentRow) {
                    button.addEventListener('click', function(event) {
                        event.preventDefault();
                        var direction = button.getAttribute('data-direction');
                        moveRow(currentRow, direction);
                    });
                })(moveButtons[i], row);
            }
            var removeButton = row.querySelector('.remove-exercise-button');
            if (removeButton) {
                removeButton.addEventListener('click', function(event) {
                    event.preventDefault();
                    handleRemoveRow(row);
                });
            }
        }

        function createExerciseRow(options) {
            if (!currentExercisesTbody) {
                return null;
            }
            var row = document.createElement('tr');
            row.className = 'template-exercise-row';
            if (options && options.templateExerciseId) {
                row.setAttribute('data-template-exercise-id', String(options.templateExerciseId));
            } else if (options && options.exerciseId) {
                row.setAttribute('data-new-exercise-id', String(options.exerciseId));
            }

            var positionCell = document.createElement('td');
            positionCell.className = 'text-center align-middle position-cell';
            var positionSpan = document.createElement('span');
            positionSpan.className = 'exercise-position';
            positionCell.appendChild(positionSpan);
            row.appendChild(positionCell);

            var nameCell = document.createElement('td');
            nameCell.className = 'align-middle';
            if (options && options.name) {
                nameCell.textContent = options.name;
            } else {
                nameCell.textContent = 'Esercizio';
            }
            if (options && options.isGlobal) {
                var space = document.createTextNode(' ');
                var icon = document.createElement('i');
                icon.className = 'bi bi-globe2 global-icon';
                icon.title = 'Esercizio globale';
                nameCell.appendChild(space);
                nameCell.appendChild(icon);
            }
            row.appendChild(nameCell);

            var setsCell = document.createElement('td');
            setsCell.className = 'align-middle';
            var setsInput = document.createElement('input');
            setsInput.type = 'text';
            setsInput.className = 'form-control form-control-sm sets-input';
            var setsValue = options && typeof options.sets !== 'undefined' ? options.sets : '1';
            setsInput.value = setsValue;
            setsCell.appendChild(setsInput);
            row.appendChild(setsCell);

            var actionsCell = document.createElement('td');
            actionsCell.className = 'text-center align-middle';
            var actionsWrapper = document.createElement('div');
            actionsWrapper.className = 'd-flex justify-content-center align-items-center gap-2 flex-wrap';

            var reorderContainer = document.createElement('div');
            reorderContainer.className = 'reorder-controls d-flex flex-column align-items-stretch gap-1';
            reorderContainer.setAttribute('aria-label', 'Riordina esercizio');

            var upButton = document.createElement('button');
            upButton.type = 'button';
            upButton.className = 'btn btn-sm btn-outline-secondary move-exercise-button';
            upButton.setAttribute('data-direction', 'up');
            upButton.title = 'Sposta su';
            upButton.innerHTML = '<i class="bi bi-arrow-up"></i>';
            reorderContainer.appendChild(upButton);

            var downButton = document.createElement('button');
            downButton.type = 'button';
            downButton.className = 'btn btn-sm btn-outline-secondary move-exercise-button';
            downButton.setAttribute('data-direction', 'down');
            downButton.title = 'Sposta giÃ¹';
            downButton.innerHTML = '<i class="bi bi-arrow-down"></i>';
            reorderContainer.appendChild(downButton);

            actionsWrapper.appendChild(reorderContainer);

            var removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'btn btn-sm btn-delete remove-exercise-button';
            removeButton.title = 'Rimuovi esercizio';
            removeButton.innerHTML = '<i class="bi bi-trash"></i>';
            actionsWrapper.appendChild(removeButton);

            actionsCell.appendChild(actionsWrapper);
            row.appendChild(actionsCell);

            if (emptyStateRow && emptyStateRow.parentNode === currentExercisesTbody) {
                currentExercisesTbody.insertBefore(row, emptyStateRow);
            } else {
                currentExercisesTbody.appendChild(row);
            }

            attachRowEvents(row);
            updateEmptyState();
            refreshReorderButtons();
            updateExercisePositions();
            return row;
        }

        function collectState() {
            var rows = getExerciseRows();
            var payload = { items: [], deleted: [] };

            for (var i = 0; i < rows.length; i++) {
                var row = rows[i];
                var setsInput = row.querySelector('.sets-input');
                var rawValue = setsInput ? setsInput.value.trim() : '';
                if (rawValue === '') {
                    throw new Error('Inserisci un numero di serie valido per tutti gli esercizi.');
                }
                var parsedSets = parseInt(rawValue, 10);
                if (isNaN(parsedSets) || parsedSets < 0) {
                    throw new Error('Inserisci un numero di serie valido per tutti gli esercizi.');
                }

                var templateExerciseId = row.getAttribute('data-template-exercise-id');
                if (templateExerciseId) {
                    var existingId = parseInt(templateExerciseId, 10);
                    if (isNaN(existingId)) {
                        throw new Error('Dati esercizio non validi.');
                    }
                    payload.items.push({
                        type: 'existing',
                        template_exercise_id: existingId,
                        sets: parsedSets
                    });
                } else {
                    var newExerciseId = row.getAttribute('data-new-exercise-id');
                    var parsedExerciseId = parseInt(newExerciseId, 10);
                    if (!newExerciseId || isNaN(parsedExerciseId)) {
                        throw new Error('Dati esercizio non validi.');
                    }
                    payload.items.push({
                        type: 'new',
                        exercise_id: parsedExerciseId,
                        sets: parsedSets
                    });
                }
            }

            for (var d = 0; d < deletedExercises.length; d++) {
                var deletedId = parseInt(deletedExercises[d], 10);
                if (!isNaN(deletedId)) {
                    payload.deleted.push(deletedId);
                }
            }

            return payload;
        }

        function renderHighlightedLabel(cell, label, term, isGlobal) {
            if (!cell) {
                return;
            }

            var normalizedTerm = term ? String(term).toLowerCase() : '';
            var normalizedLabel = String(label || '');
            var lowerLabel = normalizedLabel.toLowerCase();
            var startIndex = normalizedTerm ? lowerLabel.indexOf(normalizedTerm) : -1;

            while (cell.firstChild) {
                cell.removeChild(cell.firstChild);
            }

            if (!normalizedTerm || startIndex === -1) {
                cell.appendChild(document.createTextNode(normalizedLabel));
            } else {
                var beforeText = normalizedLabel.slice(0, startIndex);
                var matchText = normalizedLabel.slice(startIndex, startIndex + normalizedTerm.length);
                var afterText = normalizedLabel.slice(startIndex + normalizedTerm.length);

                if (beforeText) {
                    cell.appendChild(document.createTextNode(beforeText));
                }

                var mark = document.createElement('mark');
                mark.textContent = matchText;
                cell.appendChild(mark);

                if (afterText) {
                    cell.appendChild(document.createTextNode(afterText));
                }
            }

            if (isGlobal) {
                var spaceNode = document.createTextNode(' ');
                var icon = document.createElement('i');
                icon.className = 'bi bi-globe2 global-icon';
                icon.title = 'Esercizio globale';
                cell.appendChild(spaceNode);
                cell.appendChild(icon);
            }
        }

        if (exercisesTbody) {
            var initialExerciseRows = exercisesTbody.querySelectorAll('.exercise-row');
            for (var idx = 0; idx < initialExerciseRows.length; idx++) {
                var rowElement = initialExerciseRows[idx];
                allExerciseRows.push({
                    element: rowElement,
                    normalizedName: (rowElement.getAttribute('data-name') || '').toLowerCase(),
                    originalIndex: idx
                });
            }
        }

        function ensureNoExerciseResultsRow() {
            if (!noExerciseResultsRow) {
                noExerciseResultsRow = document.createElement('tr');
                noExerciseResultsRow.className = 'no-exercise-results';
                var cell = document.createElement('td');
                cell.colSpan = 2;
                cell.className = 'text-center text-muted py-3';
                cell.textContent = 'Nessun esercizio trovato.';
                noExerciseResultsRow.appendChild(cell);
            }
            return noExerciseResultsRow;
        }

        function renderExerciseRows(rowsToRender, searchTerm) {
            if (!exercisesTbody) {
                return;
            }

            while (exercisesTbody.firstChild) {
                exercisesTbody.removeChild(exercisesTbody.firstChild);
            }

            if (!rowsToRender || rowsToRender.length === 0) {
                exercisesTbody.appendChild(ensureNoExerciseResultsRow());
                return;
            }

            if (noExerciseResultsRow && noExerciseResultsRow.parentNode === exercisesTbody) {
                exercisesTbody.removeChild(noExerciseResultsRow);
            }

            var fragment = document.createDocumentFragment();
            for (var i = 0; i < rowsToRender.length; i++) {
                var rowData = rowsToRender[i];
                if (!rowData || !rowData.element) {
                    continue;
                }
                rowData.element.classList.remove('d-none');

                var exerciseName = rowData.element.getAttribute('data-exercise-name') || '';
                var displayCell = rowData.element.querySelector('td');
                if (displayCell) {
                    var isGlobal = rowData.element.getAttribute('data-is-global') === '1';
                    renderHighlightedLabel(displayCell, exerciseName, searchTerm || '', isGlobal);
                }
                fragment.appendChild(rowData.element);
            }
            exercisesTbody.appendChild(fragment);
        }

        function applyExerciseFilter() {
            if (!exercisesTbody) {
                return;
            }

            var rawValue = searchInput && typeof searchInput.value === 'string' ? searchInput.value : '';
            var searchTerm = rawValue.toLowerCase().trim();

            if (!searchTerm) {
                renderExerciseRows(allExerciseRows.slice().sort(function(a, b) {
                    return a.originalIndex - b.originalIndex;
                }), '');
                return;
            }

            var prefixMatches = [];
            var containsMatches = [];

            for (var j = 0; j < allExerciseRows.length; j++) {
                var rowData = allExerciseRows[j];
                if (!rowData || !rowData.normalizedName) {
                    continue;
                }

                if (rowData.normalizedName.indexOf(searchTerm) === 0) {
                    prefixMatches.push(rowData);
                } else if (rowData.normalizedName.indexOf(searchTerm) > -1) {
                    containsMatches.push(rowData);
                }
            }

            renderExerciseRows(prefixMatches.concat(containsMatches), searchTerm);
        }

        if (searchInput) {
            searchInput.addEventListener('input', function() {
                applyExerciseFilter();
            });
            searchInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    applyExerciseFilter();
                }
            });
        }
        if (searchButton) {
            searchButton.addEventListener('click', function(event) {
                event.preventDefault();
                applyExerciseFilter();
            });
        }

        var addButtons = document.querySelectorAll('.add-exercise-button');
        for (var a = 0; a < addButtons.length; a++) {
            addButtons[a].addEventListener('click', function(event) {
                event.preventDefault();
                var button = event.currentTarget;
                var exerciseRow = button.closest('.exercise-row');
                if (!exerciseRow) {
                    return;
                }
                var exerciseId = exerciseRow.getAttribute('data-exercise-id');
                var exerciseName = exerciseRow.getAttribute('data-exercise-name');
                var isGlobal = exerciseRow.getAttribute('data-is-global') === '1';
                createExerciseRow({
                    exerciseId: parseInt(exerciseId, 10),
                    name: exerciseName,
                    sets: '1',
                    isGlobal: isGlobal
                });
            });
        }

        if (currentExercisesTbody) {
            var initialRows = currentExercisesTbody.querySelectorAll('tr[data-template-exercise-id]');
            for (var r = 0; r < initialRows.length; r++) {
                attachRowEvents(initialRows[r]);
            }
        }

        updateEmptyState();
        refreshReorderButtons();
        updateExercisePositions();

        applyExerciseFilter();

        if (cancelButton) {
            cancelButton.addEventListener('click', function(event) {
                event.preventDefault();
                if (window.confirm('Vuoi annullare le modifiche apportate alla scheda?')) {
                    var cancelUrl = cancelButton.getAttribute('href');
                    if (cancelUrl) {
                        window.location.href = cancelUrl;
                    } else {
                        window.history.back();
                    }
                }
            });
        }

        if (templateForm) {
            templateForm.addEventListener('submit', function(event) {
                if (formSubmitting) {
                    return;
                }
                event.preventDefault();
                var payload;
                try {
                    payload = collectState();
                } catch (error) {
                    var message = (error && error.message) ? error.message : 'Impossibile salvare le modifiche.';
                    alert(message);
                    return;
                }

                if (!window.confirm('Confermi di voler salvare le modifiche apportate alla scheda?')) {
                    return;
                }

                if (stateInput) {
                    stateInput.value = JSON.stringify(payload);
                }

                formSubmitting = true;
                templateForm.submit();
            });
        }

        if (saveButton) {
            saveButton.addEventListener('click', function(event) {
                // L'evento di submit gestisce la conferma, qui evitiamo duplicazioni.
            });
        }
    });
</script>
{% endblock %}
