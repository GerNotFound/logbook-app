{% extends 'layout.html' %}
{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4 brand-heading"><span class="logbook-brand brand-heading__brand">LOGBOOK</span><span class="brand-heading__section">/ MODIFICA SCHEDA</span></h1>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">{{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>
</div>

<!-- Inizia il componente Alpine.js -->
<div x-data="templateEditor()" x-init="init()">
    <form id="edit-template-form" method="POST" action="{{ url_for('gym.modifica_scheda_dettaglio', template_id=template.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <!-- Sezione Nome Scheda -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0" x-text="templateName"></h4>
            <button type="button" class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#renameTemplateModal">Rinomina</button>
        </div>

        <!-- Sezione Esercizi nella Scheda -->
        <div class="mb-4">
            <h5>Esercizi</h5>
            <div class="table-responsive">
                <table class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>Esercizio</th>
                            <th class="serie-column">Serie</th>
                            <th class="text-center">Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Ciclo dinamico gestito da Alpine.js -->
                        <template x-for="(exercise, index) in currentExercises" :key="exercise.exercise_id">
                            <tr :data-exercise-id="exercise.exercise_id">
                                <!-- Input nascosto per inviare l'ID al server -->
                                <input type="hidden" name="exercise_id" :value="exercise.exercise_id">
                                <td class="align-middle" x-text="exercise.name"></td>
                                <td class="align-middle">
                                    <input type="text" class="form-control form-control-sm" :name="'sets_' + exercise.exercise_id" x-model="exercise.sets">
                                </td>
                                <td class="text-center align-middle">
                                    <div class="btn-group">
                                        <button @click="moveUp(index)" type="button" class="btn btn-sm btn-outline-light" title="Sposta su" :disabled="index === 0"><i class="bi bi-arrow-up"></i></button>
                                        <button @click="moveDown(index)" type="button" class="btn btn-sm btn-outline-light" title="Sposta giù" :disabled="index === currentExercises.length - 1"><i class="bi bi-arrow-down"></i></button>
                                        <button @click="removeExercise(index)" type="button" class="btn btn-sm btn-delete" title="Rimuovi Esercizio"><i class="bi bi-trash"></i></button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
                <p class="text-center text-muted" x-show="currentExercises.length === 0">Nessun esercizio in questa scheda.</p>
            </div>
        </div>
    </form>

    <!-- Sezione Ricerca Esercizi -->
    <div class="mb-4">
        <h5>Cerca Esercizio</h5>
        <input type="text" class="form-control" placeholder="Digita per filtrare gli esercizi..." x-model="searchTerm">
        <a href="{{ url_for('gym.esercizi') }}" class="btn btn-custom w-100 d-block mt-3">CREA ESERCIZIO</a>
        
        <div class="table-responsive mt-3" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-bordered table-hover table-sm">
                <thead>
                    <tr>
                        <th>Esercizio</th>
                        <th class="text-center">Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Ciclo dinamico per la lista filtrata -->
                    <template x-for="exercise in filteredExercises" :key="exercise.id">
                        <tr>
                            <td x-html="exercise.name + (exercise.user_id === null ? ' <i class=\'bi bi-globe2 global-icon\' title=\'Esercizio globale\'></i>' : '')"></td>
                            <td class="text-center">
                                <button @click="addExercise(exercise)" type="button" class="btn btn-sm btn-outline-light">Aggiungi</button>
                                <a :href="'/esercizio/' + exercise.id + '/info'" class="btn btn-sm btn-outline-secondary">Info</a>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modale per Rinomina -->
    <div class="modal fade" id="renameTemplateModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Rinomina Scheda</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <label for="new_template_name" class="form-label">Nuovo nome</label>
                    <input type="text" name="new_template_name" id="new_template_name" class="form-control" x-model="templateName" required form="edit-template-form">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-custom btn-custom-tight m-0" data-bs-dismiss="modal">Conferma</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pulsanti in fondo alla pagina -->
    <div class="sticky-bottom-nav">
        <button type="submit" form="edit-template-form" class="btn btn-custom action-btn">SALVA</button>
        <a id="cancel-button" href="{{ url_for('gym.scheda') }}" class="btn btn-custom action-btn" x-text="isDirty ? 'ANNULLA' : 'INDIETRO'">INDIETRO</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Inclusione di Alpine.js -->
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

<script nonce="{{ csp_nonce() }}">
    document.addEventListener('alpine:init', () => {
        Alpine.data('templateEditor', () => ({
            // --- STATO (I DATI INIZIALI) ---
            // Questi dati vengono "iniettati" dal server tramite Jinja2
            templateName: {{ template.name|tojson|safe }},
            currentExercises: {{ current_exercises|tojson|safe }},
            allExercises: {{ all_exercises|tojson|safe }},
            searchTerm: '',
            initialState: '',

            // --- GETTERS (PROPRIETÀ CALCOLATE) ---
            
            // Controlla se sono state fatte modifiche
            get isDirty() {
                const currentState = JSON.stringify({
                    name: this.templateName,
                    exercises: this.currentExercises.map(e => ({ id: e.exercise_id, sets: e.sets }))
                });
                return this.initialState !== currentState;
            },

            // Filtra la lista di tutti gli esercizi in base alla ricerca
            get filteredExercises() {
                if (this.searchTerm.trim() === '') {
                    return this.allExercises;
                }
                const lowerTerm = this.searchTerm.toLowerCase();
                return this.allExercises.filter(ex => 
                    ex.name.toLowerCase().includes(lowerTerm)
                );
            },

            // --- METODI (LE AZIONI) ---
            
            // Funzione di inizializzazione
            init() {
                // Salva una "fotografia" dello stato iniziale per confrontarlo in seguito
                this.initialState = JSON.stringify({
                    name: this.templateName,
                    exercises: this.currentExercises.map(e => ({ id: e.exercise_id, sets: e.sets }))
                });
            },

            // Aggiunge un esercizio alla scheda
            addExercise(exerciseToAdd) {
                const isAlreadyAdded = this.currentExercises.some(ex => ex.exercise_id === exerciseToAdd.id);
                if (isAlreadyAdded) {
                    alert("Questo esercizio è già nella scheda.");
                    return;
                }
                this.currentExercises.push({
                    exercise_id: exerciseToAdd.id,
                    name: exerciseToAdd.name,
                    sets: '1'
                });
            },

            // Rimuove un esercizio dalla scheda
            removeExercise(index) {
                this.currentExercises.splice(index, 1);
            },

            // Sposta un esercizio in su
            moveUp(index) {
                if (index > 0) {
                    // Scambia l'elemento con il precedente nell'array
                    [this.currentExercises[index - 1], this.currentExercises[index]] = [this.currentExercises[index], this.currentExercises[index - 1]];
                }
            },

            // Sposta un esercizio in giù
            moveDown(index) {
                if (index < this.currentExercises.length - 1) {
                    // Scambia l'elemento con il successivo nell'array
                    [this.currentExercises[index], this.currentExercises[index + 1]] = [this.currentExercises[index + 1], this.currentExercises[index]];
                }
            }
        }));
    });
</script>
{% endblock %}