{% extends 'layout.html' %}
{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4 brand-heading"><span class="logbook-brand brand-heading__brand">LOGBOOK</span><span class="brand-heading__section">/ MODIFICA SCHEDA</span></h1>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">{{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>
</div>

<form id="edit-template-form" method="POST" action="{{ url_for('gym.modifica_scheda_dettaglio', template_id=template.id) }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="action" value="save_all">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">{{ template.name }}</h4>
        <button type="button" class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#renameTemplateModal">Rinomina</button>
    </div>

    <div class="mb-4">
        <h5>Esercizi</h5>
        <div class="table-responsive">
            <table class="table table-sm table-bordered">
                <thead>
                    <tr>
                        <th class="text-center" style="width: 50px;">Ordina</th>
                        <th>Esercizio</th>
                        <th class="serie-column">Serie</th>
                        <th class="text-center">Azioni</th>
                    </tr>
                </thead>
                <tbody id="sortable-exercises">
                    {% for exercise in current_exercises %}
                    <tr data-exercise-id="{{ exercise.id }}">
                        <input type="hidden" name="exercise_order" value="{{ exercise.id }}">
                        <td class="text-center align-middle sort-handle" style="cursor: grab;"><i class="bi bi-grip-vertical"></i></td>
                        <td class="align-middle">{{ exercise.name }}</td>
                        <td class="align-middle">
                            <input type="text" class="form-control form-control-sm" name="sets_{{ exercise.id }}" value="{{ exercise.sets }}">
                        </td>
                        <td class="text-center align-middle">
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-light move-up" title="Sposta su"><i class="bi bi-arrow-up"></i></button>
                                <button type="button" class="btn btn-sm btn-outline-light move-down" title="Sposta giù"><i class="bi bi-arrow-down"></i></button>
                                <button type="submit" form="delete-form-{{ exercise.id }}" class="btn btn-sm btn-delete" title="Elimina Esercizio"><i class="bi bi-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="4" class="text-center text-muted">Nessun esercizio in questa scheda.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</form>

<!-- Form separati per l'eliminazione -->
{% for exercise in current_exercises %}
<form id="delete-form-{{ exercise.id }}" method="POST" action="{{ url_for('gym.modifica_scheda_dettaglio', template_id=template.id) }}" onsubmit="return confirm('Sei sicuro?');" class="d-none">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="action" value="delete_template_exercise">
    <input type="hidden" name="template_exercise_id" value="{{ exercise.id }}">
</form>
{% endfor %}

<div class="mb-4">
    <h5>Cerca Esercizio</h5>
    <div class="input-group">
        <input type="text" id="search-exercise-input" class="form-control" placeholder="Digita per filtrare gli esercizi...">
        <a href="{{ url_for('gym.esercizi') }}" class="btn btn-outline-light">Crea</a>
    </div>
    <div class="table-responsive mt-2" style="max-height: 400px; overflow-y: auto;">
        <table class="table table-bordered table-hover table-sm">
            <thead>
                <tr>
                    <th>Esercizio</th>
                    <th class="text-center">Azioni</th>
                </tr>
            </thead>
            <tbody id="all-exercises-tbody">
                {% for exercise in all_exercises %}
                <tr class="exercise-row" data-name="{{ exercise.name | lower }}">
                    <td>{{ exercise.name }} {% if exercise.user_id is none %}<i class="bi bi-globe2 global-icon" title="Esercizio globale"></i>{% endif %}</td>
                    <td class="text-center">
                        <form method="POST" class="d-inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" value="add_exercise_to_template">
                            <input type="hidden" name="exercise_id" value="{{ exercise.id }}">
                            <button type="submit" class="btn btn-sm btn-outline-light">Aggiungi</button>
                        </form>
                        <a href="{{ url_for('gym.esercizio_info', exercise_id=exercise.id) }}" class="btn btn-sm btn-outline-secondary">Info</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal per rinominare la scheda -->
<div class="modal fade" id="renameTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Rinomina Scheda</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <label for="new_template_name" class="form-label">Nuovo nome</label>
                <input type="text" name="new_template_name" id="new_template_name" class="form-control" value="{{ template.name }}" required form="edit-template-form">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-custom btn-custom-tight m-0" data-bs-dismiss="modal">Conferma</button>
            </div>
        </div>
    </div>
</div>

<div class="sticky-bottom-nav">
    <button type="submit" form="edit-template-form" class="btn btn-custom action-btn">SALVA</button>
    <a href="{{ url_for('gym.scheda') }}" class="btn btn-custom action-btn">ANNULLA</a>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script nonce="{{ csp_nonce() }}">
    document.addEventListener('DOMContentLoaded', function() {
        // Logica per il filtro live della tabella
        const searchInput = document.getElementById('search-exercise-input');
        const exerciseRows = document.querySelectorAll('#all-exercises-tbody .exercise-row');

        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            exerciseRows.forEach(row => {
                const exerciseName = row.dataset.name;
                if (exerciseName.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // Logica per l'ordinamento
        const sortableList = document.getElementById('sortable-exercises');
        if (sortableList) {
            new Sortable(sortableList, {
                animation: 150,
                handle: '.sort-handle',
                onEnd: function() {
                    updateOrderInputs();
                }
            });
        }

        function updateOrderInputs() {
            const form = document.getElementById('edit-template-form');
            // Rimuovi i vecchi input di ordine
            form.querySelectorAll('input[name="exercise_order"]').forEach(input => input.remove());
            
            // Aggiungi i nuovi input aggiornati in base all'ordine del DOM
            const rows = sortableList.querySelectorAll('tr');
            rows.forEach(row => {
                const exerciseId = row.dataset.exerciseId;
                if (exerciseId) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'exercise_order';
                    input.value = exerciseId;
                    form.appendChild(input);
                }
            });
        }

        // Logica per i pulsanti Su/Giù
        document.querySelectorAll('.move-up').forEach(button => {
            button.addEventListener('click', function() {
                const row = this.closest('tr');
                const prevRow = row.previousElementSibling;
                if (prevRow) {
                    sortableList.insertBefore(row, prevRow);
                    updateOrderInputs();
                }
            });
        });

        document.querySelectorAll('.move-down').forEach(button => {
            button.addEventListener('click', function() {
                const row = this.closest('tr');
                const nextRow = row.nextElementSibling;
                if (nextRow) {
                    sortableList.insertBefore(nextRow, row);
                    updateOrderInputs();
                }
            });
        });
    });
</script>
{% endblock %}