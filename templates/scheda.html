{% extends 'layout.html' %}
{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4 brand-heading"><span class="logbook-brand brand-heading__brand">LOGBOOK</span><span class="brand-heading__section">/ SCHEDA</span></h1>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}{% for category, message in messages %}<div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">{{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>{% endfor %}{% endif %}
        {% endwith %}
    </div>
</div>

<div class="mb-4 p-3 border rounded">
    <h5>Crea Nuova Scheda</h5>
    <form id="create-template-form" method="POST" action="{{ url_for('gym.scheda') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="add_template">
        <div class="row g-2 align-items-center">
            <div class="col"><input type="text" name="template_name" class="form-control mb-0" placeholder="Es. Giorno A - Spinta" required></div>
            <div class="col-auto"><button type="submit" class="btn btn-custom btn-custom-short">Crea</button></div>
        </div>
    </form>
</div>

{% if templates %}
    {% for template in templates %}
    <div class="mb-4 p-3 border rounded" id="template-{{ template.id }}">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0 template-name">{{ template.name }}</h4>
            <div>
                <button type="button" class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#renameTemplateModal-{{ template.id }}">Rinomina</button>
                <form method="POST" action="{{ url_for('gym.scheda') }}" onsubmit="return confirm('Sei sicuro?');" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"><input type="hidden" name="action" value="delete_template"><input type="hidden" name="template_id" value="{{ template.id }}">
                    <button type="submit" class="btn btn-sm btn-delete">Elimina</button>
                </form>
            </div>
        </div>
        <table class="table table-bordered table-sm">
            <thead><tr><th>Esercizio</th><th>Serie</th><th></th></tr></thead>
            <tbody id="tbody-template-{{ template.id }}">
            {% for exercise in template.exercises %}
                <tr id="tex-{{ exercise.id }}">
                    <td>{{ exercise.name }}{% if exercise.user_id is none %}<i class="bi bi-globe2 global-icon" title="Esercizio globale" aria-label="Esercizio globale"></i>{% endif %}</td>
                    <td>
                        <form class="update-sets-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="template_exercise_id" value="{{ exercise.id }}">
                            <div class="input-group">
                                <input type="text" class="form-control form-control-sm" name="sets" value="{{ exercise.sets }}">
                                <button type="submit" class="btn btn-sm btn-outline-light">Salva</button>
                            </div>
                        </form>
                    </td>
                    <td class="text-center">
                        <form method="POST" action="{{ url_for('gym.scheda') }}" onsubmit="return confirm('Sei sicuro?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" value="delete_template_exercise">
                            <input type="hidden" name="template_id" value="{{ template.id }}">
                            <input type="hidden" name="template_exercise_id" value="{{ exercise.id }}">
                            <button type="submit" class="btn btn-sm btn-delete">X</button>
                        </form>
                    </td>
                </tr>
            {% else %}
                <tr class="no-exercise-row-{{ template.id }}"><td colspan="3" class="text-center text-muted">Aggiungi un esercizio.</td></tr>
            {% endfor %}
            </tbody>
        </table>
        <div class="text-end">
            <a href="{{ url_for('gym.modifica_scheda_dettaglio', template_id=template.id) }}" class="btn btn-custom btn-custom-short">
                Modifica / Aggiungi
            </a>
        </div>
    </div>

    <div class="modal fade" id="renameTemplateModal-{{ template.id }}" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Rinomina Scheda</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <form method="POST" action="{{ url_for('gym.scheda') }}">
                    <div class="modal-body">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"><input type="hidden" name="template_id" value="{{ template.id }}"><input type="hidden" name="action" value="rename_template">
                        <label for="new_template_name-{{ template.id }}" class="form-label">Nuovo nome</label>
                        <input type="text" name="new_template_name" id="new_template_name-{{ template.id }}" class="form-control" value="{{ template.name }}" required>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                        <button type="submit" class="btn btn-custom btn-custom-tight m-0">Salva</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="alert alert-secondary text-center">Nessuna scheda di allenamento trovata.</div>
{% endif %}

<div class="sticky-bottom-nav"><a href="{{ url_for('gym.palestra') }}" class="btn btn-custom full-width-btn">INDIETRO</a></div>
{% endblock %}
{% block scripts %}
<script nonce="{{ csp_nonce() }}">
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.update-sets-form').forEach(form => {
        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = '...';

            try {
                const response = await fetch("{{ url_for('gym.aggiorna_serie') }}", {
                    method: 'POST',
                    body: new FormData(this)
                });
                const data = await response.json();
                if (response.ok && data.success) {
                    submitButton.textContent = 'OK!';
                } else {
                    alert(data.error || 'Errore');
                    submitButton.textContent = 'Errore';
                }
            } catch (error) {
                alert('Errore di rete.');
                submitButton.textContent = 'Errore';
            } finally {
                setTimeout(() => {
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }, 1500);
            }
        });
    });
});
</script>
{% endblock %}