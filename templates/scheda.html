{% extends 'layout.html' %}
{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">LOGBOOK - SCHEDA</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>
</div>

<div class="mb-4 p-3 border rounded">
    <h5>Crea Nuova Scheda</h5>
    <form id="create-template-form" method="POST" action="{{ url_for('gym.scheda') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="add_template">
        <div class="row g-2 align-items-center">
            <div class="col">
                <input type="text" name="template_name" class="form-control" placeholder="Es. Giorno A - Spinta" required style="margin-bottom: 0;">
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-custom" style="padding: 12px 15px; min-height: auto; height: 44px;">Crea</button>
            </div>
        </div>
    </form>
</div>

{% if templates %}
    {% for template in templates %}
    <div class="mb-4 p-3 border rounded" id="template-{{ template.id }}">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">{{ template.name }}</h4>
            <div>
                <button type="button" class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#renameTemplateModal-{{ template.id }}">
                    Rinomina
                </button>
                <form method="POST" action="{{ url_for('gym.scheda') }}" onsubmit="return confirm('Sei sicuro di voler eliminare questa scheda e tutti i suoi esercizi?');" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="delete_template">
                    <input type="hidden" name="template_id" value="{{ template.id }}">
                    <button type="submit" class="btn btn-sm btn-delete">Elimina</button>
                </form>
            </div>
        </div>

        <table class="table table-bordered table-sm">
            <thead>
                <tr>
                    <th>Esercizio</th>
                    <th>Serie</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            {% for exercise in template.exercises %}
                <tr id="tex-{{ exercise.id }}">
                    <td>{{ exercise.name }}</td>
                    <td>{{ exercise.sets }}</td>
                    <td class="text-center">
                        <form method="POST"
                              data-ajax-url="{{ url_for('gym.elimina_esercizio_ajax') }}"
                              data-ajax-success="onTemplateExerciseDeleted"
                              data-ajax-confirm="Sei sicuro di voler eliminare questo esercizio dalla scheda?">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="template_exercise_id" value="{{ exercise.id }}">
                            <button type="submit" class="btn btn-sm btn-delete">X</button>
                        </form>
                    </td>
                </tr>
            {% else %}
                <tr class="no-exercise-row"><td colspan="3" class="text-center text-muted">Aggiungi un esercizio a questa scheda.</td></tr>
            {% endfor %}
            </tbody>
        </table>

        <form id="add-exercise-form-{{ template.id }}"
              data-ajax-url="{{ url_for('gym.aggiungi_esercizio_ajax') }}"
              data-ajax-success="onAddExerciseSuccess">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="template_id" value="{{ template.id }}">
            <input type="hidden" name="exercise_id" class="exercise-id-input">

            <div class="row g-2 d-flex align-items-end">
                <div class="col">
                    <label class="form-label mb-1" style="font-size: 0.8rem;">Esercizio</label>
                    <div class="suggestions-container">
                        <input type="text" class="form-control exercise-search-input" placeholder="Cerca..." autocomplete="off" required style="margin-bottom: 0;">
                        <div class="suggestions-list"></div>
                    </div>
                </div>
                <div class="col-auto" style="width: 80px;">
                    <label class="form-label mb-1" style="font-size: 0.8rem;">Serie</label>
                    <input type="text" inputmode="numeric" pattern="[0-9]*" name="sets" class="form-control" required style="margin-bottom: 0;">
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-custom" style="padding: 12px 15px; min-height: auto; height: 44px;">Aggiungi</button>
                </div>
            </div>
        </form>
    </div>

    <div class="modal fade" id="renameTemplateModal-{{ template.id }}" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Rinomina Scheda</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST"
                      action="{{ url_for('gym.scheda') }}"
                      data-ajax-url="{{ url_for('gym.rinomina_scheda_ajax') }}"
                      data-ajax-success="onRenameTemplateSuccess">
                    <div class="modal-body">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="action" value="rename_template">
                        <input type="hidden" name="template_id" value="{{ template.id }}">
                        <label for="new_template_name-{{ template.id }}" class="form-label">Nuovo nome</label>
                        <input type="text" name="new_template_name" id="new_template_name-{{ template.id }}" class="form-control" value="{{ template.name }}" required>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                        <button type="submit" class="btn btn-custom" style="margin: 0; min-height: auto;">Salva</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="alert alert-secondary text-center">Nessuna scheda di allenamento trovata. Creane una per iniziare.</div>
{% endif %}

<div class="sticky-bottom-nav">
    <a href="{{ url_for('gym.palestra') }}" class="btn btn-custom full-width-btn">INDIETRO</a>
</div>
{% endblock %}

{% block scripts %}
<script>
    const exerciseList = {{ all_exercises|tojson|safe }};

    document.querySelectorAll('.exercise-search-input').forEach(searchInput => {
        const parentForm = searchInput.closest('form');
        const suggestionsDiv = parentForm.querySelector('.suggestions-list');
        const exerciseIdInput = parentForm.querySelector('.exercise-id-input');

        function showSuggestions(term) {
            const filteredExercises = exerciseList.filter(ex => ex.name.toLowerCase().includes(term)).slice(0, 8);
            suggestionsDiv.innerHTML = '';
            if (filteredExercises.length > 0) {
                filteredExercises.forEach(ex => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.textContent = ex.name;
                    item.addEventListener('click', () => {
                        searchInput.value = ex.name;
                        exerciseIdInput.value = ex.id;
                        suggestionsDiv.style.display = 'none';
                    });
                    suggestionsDiv.appendChild(item);
                });
                suggestionsDiv.style.display = 'block';
            } else {
                suggestionsDiv.style.display = 'none';
            }
        }

        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            exerciseIdInput.value = '';
            if (searchTerm.length < 1) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            showSuggestions(searchTerm);
        });

        searchInput.addEventListener('focus', function() {
            const searchTerm = this.value.toLowerCase();
            if (searchTerm.length > 0) {
                showSuggestions(searchTerm);
            }
        });
    });

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.suggestions-container')) {
            document.querySelectorAll('.suggestions-list').forEach(div => {
                div.style.display = 'none';
            });
        }
    });

    const DRAFT_KEY_SCHEDA = `scheda_draft`;
    const schedaForm = document.getElementById('create-template-form');
    if (schedaForm) {
        const draftInput = schedaForm.querySelector('input[name="template_name"]');
        draftInput.addEventListener('input', () => {
            if (draftInput.value) {
                localStorage.setItem(DRAFT_KEY_SCHEDA, draftInput.value);
            } else {
                localStorage.removeItem(DRAFT_KEY_SCHEDA);
            }
        });
        schedaForm.addEventListener('submit', () => localStorage.removeItem(DRAFT_KEY_SCHEDA));
        const savedDraft = localStorage.getItem(DRAFT_KEY_SCHEDA);
        if (savedDraft) {
            draftInput.value = savedDraft;
        }
    }
</script>
{% endblock %}
