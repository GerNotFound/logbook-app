{% extends 'layout.html' %}
{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4 brand-heading"><span class="logbook-brand brand-heading__brand">LOGBOOK</span><span class="brand-heading__section">/ SCHEDA</span></h1>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}{% for category, message in messages %}<div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">{{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>{% endfor %}{% endif %}
        {% endwith %}
    </div>
</div>

<div class="mb-4 p-3 border rounded">
    <h5>Crea Nuova Scheda</h5>
    <form id="create-template-form" method="POST" action="{{ url_for('gym.scheda') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="add_template">
        <div class="row g-2 align-items-center">
            <div class="col"><input type="text" name="template_name" class="form-control mb-0" placeholder="Es. Giorno A - Spinta" required></div>
            <div class="col-auto"><button type="submit" class="btn btn-custom btn-custom-short">Crea</button></div>
        </div>
    </form>
</div>

{% if templates %}
    {% for template in templates %}
    <div class="mb-4 p-3 border rounded" id="template-{{ template.id }}">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0 template-name">{{ template.name }}</h4>
            <div>
                <button type="button" class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#renameTemplateModal-{{ template.id }}">Rinomina</button>
                <form method="POST" action="{{ url_for('gym.scheda') }}" onsubmit="return confirm('Sei sicuro?');" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"><input type="hidden" name="action" value="delete_template"><input type="hidden" name="template_id" value="{{ template.id }}">
                    <button type="submit" class="btn btn-sm btn-delete">Elimina</button>
                </form>
            </div>
        </div>
        <table class="table table-bordered table-sm">
            <thead><tr><th>Esercizio</th><th>Serie</th><th></th></tr></thead>
            <tbody id="tbody-template-{{ template.id }}">
            {% for exercise in template.exercises %}
                <tr id="tex-{{ exercise.id }}">
                    <td>{{ exercise.name }}{% if exercise.user_id is none %}<i class="bi bi-globe2 global-icon" title="Esercizio globale" aria-label="Esercizio globale"></i>{% endif %}</td><td>{{ exercise.sets }}</td>
                    <td class="text-center">
                        <form method="POST" action="{{ url_for('gym.scheda') }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" value="delete_template_exercise">
                            <input type="hidden" name="template_id" value="{{ template.id }}">
                            <input type="hidden" name="template_exercise_id" value="{{ exercise.id }}">
                            <button type="submit" class="btn btn-sm btn-delete">X</button>
                        </form>
                    </td>
                </tr>
            {% else %}
                <tr class="no-exercise-row-{{ template.id }}"><td colspan="3" class="text-center text-muted">Aggiungi un esercizio.</td></tr>
            {% endfor %}
            </tbody>
        </table>
        <div class="text-end">
            <button
                type="button"
                class="btn btn-custom btn-custom-short"
                data-bs-toggle="modal"
                data-bs-target="#addExerciseModal"
                data-template-id="{{ template.id }}"
                data-template-exercise-ids='{{ template.exercises | map(attribute="exercise_id") | list | tojson | safe }}'
            >Aggiungi</button>
        </div>
    </div>

    <div class="modal fade" id="renameTemplateModal-{{ template.id }}" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Rinomina Scheda</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <form method="POST" action="{{ url_for('gym.scheda') }}">
                    <div class="modal-body">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"><input type="hidden" name="template_id" value="{{ template.id }}"><input type="hidden" name="action" value="rename_template">
                        <label for="new_template_name-{{ template.id }}" class="form-label">Nuovo nome</label>
                        <input type="text" name="new_template_name" id="new_template_name-{{ template.id }}" class="form-control" value="{{ template.name }}" required>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                        <button type="submit" class="btn btn-custom btn-custom-tight m-0">Salva</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="alert alert-secondary text-center">Nessuna scheda di allenamento trovata.</div>
{% endif %}

<div class="modal fade" id="addExerciseModal" tabindex="-1" aria-labelledby="addExerciseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title" id="addExerciseModalLabel">Aggiungi esercizio</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Chiudi"></button></div>
            <form id="add-exercise-modal-form">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="template_id" value="">
                    <input type="hidden" name="exercise_id" class="exercise-id-input">
                    <div class="mb-3">
                        <label class="form-label">Esercizio</label>
                        <div class="suggestions-container">
                            <input type="text" name="exercise_name" class="form-control exercise-search-input" placeholder="Cerca nell'archivio" autocomplete="off" required>
                            <div class="suggestions-list"></div>
                        </div>
                    </div>
                    <div>
                        <label class="form-label">Serie</label>
                        <input type="text" inputmode="numeric" pattern="[0-9]*" name="sets" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-custom w-100 m-0">SALVA</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="sticky-bottom-nav"><a href="{{ url_for('gym.palestra') }}" class="btn btn-custom full-width-btn">INDIETRO</a></div>
{% endblock %}
{% block scripts %}
<script defer src="{{ url_for('static', filename='js/catalog_suggestions.js') }}?v={{ app_version }}"></script>
<script nonce="{{ csp_nonce() }}">
    function onAddExerciseSuccess(payload) {
        const { exercise, csrf_token } = payload;
        const form = document.getElementById('add-exercise-modal-form');
        const templateId = form.querySelector('input[name="template_id"]').value;
        const tableBody = document.getElementById(`tbody-template-${templateId}`);
        if (!tableBody) return;

        // Rimuovi la riga "Nessun esercizio" se presente
        const noExerciseRow = tableBody.querySelector(`.no-exercise-row-${templateId}`);
        if (noExerciseRow) {
            noExerciseRow.remove();
        }

        // Crea la nuova riga della tabella
        const newRow = document.createElement('tr');
        newRow.id = `tex-${exercise.id}`;
        
        const globeIcon = exercise.is_global ? '<i class="bi bi-globe2 global-icon" title="Esercizio globale" aria-label="Esercizio globale"></i>' : '';

        newRow.innerHTML = `
            <td>${exercise.name}${globeIcon}</td>
            <td>${exercise.sets}</td>
            <td class="text-center">
                <form method="POST" action="{{ url_for('gym.scheda') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="delete_template_exercise">
                    <input type="hidden" name="template_id" value="${templateId}">
                    <input type="hidden" name="template_exercise_id" value="${exercise.id}">
                    <button type="submit" class="btn btn-sm btn-delete">X</button>
                </form>
            </td>
        `;
        tableBody.appendChild(newRow);

        // Resetta i campi del form nel modale
        form.querySelector('input[name="exercise_name"]').value = '';
        form.querySelector('input[name="exercise_id"]').value = '';
        form.querySelector('input[name="sets"]').value = '';
        form.querySelector('input[name="csrf_token"]').value = csrf_token; // Aggiorna il token CSRF
        
        // Rimetti il focus sul primo campo per un inserimento rapido
        form.querySelector('input[name="exercise_name"]').focus();
    }


    document.addEventListener('DOMContentLoaded', () => {
        const addExerciseForm = document.getElementById('add-exercise-modal-form');
        const addExerciseModal = document.getElementById('addExerciseModal');

        addExerciseForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'Salvataggio...';

            try {
                const response = await fetch("{{ url_for('gym.aggiungi_esercizio_ajax') }}", {
                    method: 'POST',
                    body: new FormData(this)
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    onAddExerciseSuccess(data);
                } else {
                    alert(data.error || 'Si è verificato un errore.');
                }
            } catch (error) {
                alert('Errore di rete. Riprova.');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            }
        });

        const initializeSuggestions = (suggestionsModule) => {
            if (!suggestionsModule) return;
            
            const exerciseOptions = {{ exercise_options|tojson|safe }};

            const suggestionInstance = suggestionsModule.initField({
                input: addExerciseForm.querySelector('.exercise-search-input'),
                hiddenInput: addExerciseForm.querySelector('.exercise-id-input'),
                container: addExerciseForm.querySelector('.suggestions-list'),
                form: addExerciseForm,
                items: exerciseOptions,
                globalIconLabel: 'Esercizio globale'
            });

            if (addExerciseModal && suggestionInstance) {
                const templateIdInput = addExerciseModal.querySelector('input[name="template_id"]');
                const searchInput = addExerciseModal.querySelector('.exercise-search-input');
                const setsInput = addExerciseModal.querySelector('input[name="sets"]');
                const hiddenInput = addExerciseModal.querySelector('.exercise-id-input');

                const resetModalForm = () => {
                    if (hiddenInput) { hiddenInput.value = ''; delete hiddenInput.dataset.normalized; }
                    if (searchInput) { searchInput.value = ''; }
                    if (setsInput) { setsInput.value = ''; }
                    suggestionInstance.hideSuggestions();
                    suggestionInstance.setPreferredIds([]);
                };

                addExerciseModal.addEventListener('show.bs.modal', (event) => {
                    resetModalForm();
                    const trigger = event.relatedTarget;
                    templateIdInput.value = trigger ? trigger.getAttribute('data-template-id') : '';

                    const idsRaw = trigger ? trigger.getAttribute('data-template-exercise-ids') : '[]';
                    try {
                        const parsedIds = JSON.parse(idsRaw);
                        if (Array.isArray(parsedIds)) {
                            suggestionInstance.setPreferredIds(parsedIds);
                        }
                    } catch(e) { /* ignore */ }
                });

                addExerciseModal.addEventListener('shown.bs.modal', () => {
                    searchInput.focus({ preventScroll: true });
                });

                addExerciseModal.addEventListener('hidden.bs.modal', resetModalForm);
            }
        };

        const moduleRef = window.LogbookCatalogSuggestions;
        if (moduleRef) {
            initializeSuggestions(moduleRef);
        } else {
            window.addEventListener('logbook:suggestions:ready', (e) => initializeSuggestions(e.detail), { once: true });
        }
    });
</script>
{% endblock %}