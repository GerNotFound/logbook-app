{% extends 'layout.html' %}
{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">LOGBOOK - SESSIONE PALESTRA</h1>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <a href="{{ url_for('gym.sessione_palestra', date_param=prev_day) }}" class="btn btn-outline-light">◀ Prec.</a>
            <span class="text-center">
                <h5 class="mb-0 d-inline-block align-middle">{{ date_formatted }}</h5>
                {% if not is_today %}
                    <a href="{{ url_for('gym.sessione_palestra') }}" class="btn btn-sm btn-outline-secondary ms-2">Oggi</a>
                {% endif %}
            </span>
            <a href="{{ url_for('gym.sessione_palestra', date_param=next_day) }}" class="btn btn-outline-light {% if is_today %}disabled{% endif %}">Succ. ▶</a>
        </div>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>
</div>

<div id="stopwatch-wrapper" class="stopwatch-wrapper">
    <div id="stopwatch-container" class="stopwatch-container">
        <div id="stopwatch" class="stopwatch-display">00:00</div>
        <button id="startBtn" class="btn btn-sm btn-circle ms-3">▶</button>
        <button id="pauseBtn" class="btn btn-sm btn-circle ms-2 fs-4">❚❚</button>
        <button id="stopBtn" class="btn btn-outline-light btn-sm btn-circle-outline ms-2">■</button>
    </div>
</div>

<div id="template-selection-box" class="mb-4 p-3 border rounded">
    <h5>Seleziona Scheda</h5>
    {% if templates %}
        <select id="template-selector" class="form-select form-control">
            <option value="">Nessuna scheda (allenamento libero)</option>
            {% for template in templates %}
                <option value="{{ template.id }}" {% if request.args.get('template_id')|int == template.id %}selected{% endif %}>{{ template.name }}</option>
            {% endfor %}
        </select>
    {% else %}
        <p class="text-muted">Nessuna scheda creata. Vai alla sezione apposita per iniziare.</p>
        <a href="{{ url_for('gym.scheda') }}" class="btn btn-custom w-100 d-block mt-2">VAI A SCHEDA</a>
    {% endif %}
</div>

<div id="workout-status-box" class="mb-4 p-3 border rounded d-none">
    <h5 id="status-template-name" class="mb-1"></h5>
    <p class="mb-0 text-muted">Durata: <span id="running-timer" class="fw-bold">00:00:00</span></p>
</div>


<form id="workout-form" method="POST" action="{{ url_for('gym.sessione_palestra', date_param=record_date, session_ts=session_timestamp if is_editing else None) }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" id="template-name-input" name="template_name" value="">
    <input type="hidden" id="start-timestamp-input" name="start_timestamp">
    <div id="workout-section">
        <!-- Contenuto generato da JS -->
    </div>
</form>

<div class="sticky-bottom-nav">
    <!-- MODIFICA QUI: Aggiunto onclick con confirm per il salvataggio -->
    <button type="submit" form="workout-form" class="btn btn-custom action-btn" onclick="return confirm('Sei sicuro di voler salvare la sessione?')">
        SALVA
    </button>
    <a href="#" id="cancel-workout-btn" class="btn btn-custom action-btn">ANNULLA</a>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ csp_nonce() }}">
    // La logica JavaScript di questa pagina rimane la stessa, ma con l'aggiunta della conferma su "Annulla"
    const templatesData = {{ templates|tojson|safe }};
    const logData = {{ log_data|tojson|safe }};
    const templateSelector = document.getElementById('template-selector');
    const workoutSection = document.getElementById('workout-section');
    const templateNameInput = document.getElementById('template-name-input');
    const startTimestampInput = document.getElementById('start-timestamp-input');

    const templateSelectionBox = document.getElementById('template-selection-box');
    const workoutStatusBox = document.getElementById('workout-status-box');
    const statusTemplateName = document.getElementById('status-template-name');
    const runningTimer = document.getElementById('running-timer');
    let durationTimerInterval;

    const currentUserId = {{ session['user_id'] }};
    const recordDate = '{{ record_date }}';
    const DRAFT_KEY = `workout_draft_${currentUserId}_${recordDate}`;

    function formatDuration(totalSeconds) {
        const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
        const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
        const seconds = Math.floor(totalSeconds % 60).toString().padStart(2, '0');
        return `${hours}:${minutes}:${seconds}`;
    }

    function startRunningTimer(startTimeMs) {
        if (durationTimerInterval) clearInterval(durationTimerInterval);
        
        durationTimerInterval = setInterval(() => {
            const elapsedSeconds = (Date.now() - startTimeMs) / 1000;
            runningTimer.textContent = formatDuration(elapsedSeconds);
        }, 1000);
    }

    function updateUIForTemplateSelection(templateId, startTime) {
        if (templateId) {
            const selectedTemplate = templatesData.find(t => t.id == templateId);
            if (selectedTemplate) {
                statusTemplateName.textContent = selectedTemplate.name;
                templateSelectionBox.classList.add('d-none');
                workoutStatusBox.classList.remove('d-none');
                startRunningTimer(startTime);
            }
        } else {
            templateSelectionBox.classList.remove('d-none');
            workoutStatusBox.classList.add('d-none');
            if (durationTimerInterval) clearInterval(durationTimerInterval);
        }
    }

    function saveDraft() {
        const inputs = document.querySelectorAll('#workout-section input, #workout-section textarea');
        let draftData = JSON.parse(localStorage.getItem(DRAFT_KEY)) || {};
        
        if (templateSelector) {
            draftData.selectedTemplateId = templateSelector.value;
        }
        draftData.fields = {};

        inputs.forEach(input => {
            if (input.value) draftData.fields[input.name] = input.value;
        });
        localStorage.setItem(DRAFT_KEY, JSON.stringify(draftData));
    }

    function loadDraft() {
        const draft = localStorage.getItem(DRAFT_KEY);
        return draft ? JSON.parse(draft) : {};
    }

    function clearDraft() {
        localStorage.removeItem(DRAFT_KEY);
    }

    function attachInputListeners() {
        document.querySelectorAll('#workout-section input, #workout-section textarea').forEach(input => {
            input.addEventListener('input', saveDraft);
        });
    }

    document.getElementById('workout-form').addEventListener('submit', clearDraft);

    function renderWorkout(templateId) {
        workoutSection.innerHTML = '';
        const draftFields = loadDraft().fields || {};
        if (!templateId) {
            templateNameInput.value = "Allenamento Libero";
            return;
        }
        const selectedTemplate = templatesData.find(t => t.id == templateId);
        if (!selectedTemplate) return;
        templateNameInput.value = selectedTemplate.name;
        selectedTemplate.exercises.forEach(ex => {
            const parentId = `exercise-group-${ex.id}`;
            let lastCommentText = ex.last_comment ? `<strong>${ex.last_comment_date}:</strong> ${ex.last_comment}` : 'Nessun commento precedente.';
            const commentsHtml = `<div id="comments-${ex.id}" class="collapse" data-bs-parent="#${parentId}"><div class="card card-body mt-2 text-sm">${lastCommentText}</div></div>`;
            const notesHtml = ex.notes ? `<div id="notes-${ex.id}" class="collapse" data-bs-parent="#${parentId}"><div class="card card-body mt-2 text-sm text-prewrap">${ex.notes}</div></div>` : '';
            const historyHtml = `<div id="history-${ex.id}" class="collapse" data-bs-parent="#${parentId}"><div class="card card-body mt-2 text-sm">` + ((ex.history && ex.history.length > 0)
                ? ex.history.map(session => `<div class="mb-1"><small><strong>${session.date_formatted}:</strong> ${session.sets.join(' - ')}</small></div>`).join('')
                : `<small class="text-muted">Nessuno storico precedente.</small>`)
                + `</div></div>`;
            const draftCommentKey = `comment_${ex.exercise_id}`;
            const currentCommentValue = draftFields[draftCommentKey] || (logData[draftCommentKey] || '');
            const commentBoxHtml = `<div id="comment-box-${ex.id}" class="collapse mt-2" data-bs-parent="#${parentId}"><textarea name="comment_${ex.exercise_id}" class="form-control form-control-sm" rows="2" placeholder="Aggiungi un commento...">${currentCommentValue}</textarea></div>`;
            const commentsButtonHtml = `<button type="button" class="btn btn-sm btn-outline-secondary btn-compact" data-bs-toggle="collapse" data-bs-target="#comments-${ex.id}">Commenti</button>`;
            const notesButtonHtml = ex.notes ? `<button type="button" class="btn btn-sm btn-outline-secondary btn-compact" data-bs-toggle="collapse" data-bs-target="#notes-${ex.id}">Note</button>` : '';
            const historyButtonHtml = `<button type="button" class="btn btn-sm btn-outline-secondary btn-compact" data-bs-toggle="collapse" data-bs-target="#history-${ex.id}">Storico</button>`;
            let setsHtml = '';
            for (let i = 1; i <= parseInt(ex.sets); i++) {
                const logKey = `${ex.exercise_id}_${i}`;
                const draftWeightKey = `weight_${ex.exercise_id}_${i}`;
                const draftRepsKey = `reps_${ex.exercise_id}_${i}`;
                const repsValue = draftFields[draftRepsKey] || (logData[logKey] ? logData[logKey].reps : '');
                const weightValue = draftFields[draftWeightKey] || (logData[logKey] ? logData[logKey].weight : '');
                setsHtml += `<div class="row g-2 align-items-center mb-2">
                                <div class="col-2 text-center"><span class="badge bg-secondary">Set ${i}</span></div>
                                <div class="col-5"><input type="text" name="weight_${ex.exercise_id}_${i}" class="form-control form-control-sm" placeholder="Peso (kg)" value="${weightValue}"></div>
                                <div class="col-5"><input type="number" min="0" step="1" name="reps_${ex.exercise_id}_${i}" class="form-control form-control-sm" placeholder="Reps" value="${repsValue}"></div>
                             </div>`;
            }
            const exerciseHtml = `<div class="mb-3 p-3 border rounded" id="${parentId}"><div class="d-flex justify-content-between align-items-center"><h5>${ex.name}</h5><div class="btn-group">${commentsButtonHtml}${notesButtonHtml}${historyButtonHtml}</div></div>${commentsHtml}${notesHtml}${historyHtml}<hr class="my-2">${setsHtml}<div class="mt-2"><button type="button" class="btn btn-sm btn-outline-secondary btn-compact" data-bs-toggle="collapse" data-bs-target="#comment-box-${ex.id}">+ Commento</button></div>${commentBoxHtml}</div>`;
            workoutSection.innerHTML += exerciseHtml;
        });
        attachInputListeners();
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        let draft = loadDraft();
        let startTime = draft.startTime;

        if (!startTime) {
            startTime = Date.now();
            draft.startTime = startTime;
            localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
        }
        startTimestampInput.value = startTime;

        if (draft.selectedTemplateId && templateSelector) {
            templateSelector.value = draft.selectedTemplateId;
        }
        renderWorkout(draft.selectedTemplateId);
        updateUIForTemplateSelection(draft.selectedTemplateId, startTime);
    });

    if (templateSelector) {
        templateSelector.addEventListener('change', (event) => { 
            const templateId = event.target.value;
            let startTime = Date.now();
            clearDraft();
            
            let newDraft = { startTime: startTime, selectedTemplateId: templateId };
            localStorage.setItem(DRAFT_KEY, JSON.stringify(newDraft));

            startTimestampInput.value = startTime;
            renderWorkout(templateId);
            updateUIForTemplateSelection(templateId, startTime);
            if (templateId) {
                saveDraft();
            }
        });
    }
    
    // MODIFICA QUI: Aggiunto onclick con confirm per l'annullamento
    document.getElementById('cancel-workout-btn').addEventListener('click', function(event) {
        event.preventDefault();
        if (confirm('Sei sicuro di voler annullare la sessione? I dati non salvati andranno persi.')) {
            clearDraft(); 
            window.location.href = "{{ url_for('gym.palestra') }}";
        }
    });

    const stopwatchDisplay = document.getElementById('stopwatch'); const startBtn = document.getElementById('startBtn'); const pauseBtn = document.getElementById('pauseBtn'); const stopBtn = document.getElementById('stopBtn');
    let stopwatchTimer; let stopwatchStartTime = 0; let stopwatchElapsedTime = 0; let stopwatchIsRunning = false;
    function formatStopwatchTime(seconds) { const minutes = Math.floor(seconds / 60); const secs = seconds % 60; return `${minutes < 10 ? '0' : ''}${minutes}:${secs < 10 ? '0' : ''}${secs}`; }
    function updateStopwatchDisplay() { if (stopwatchIsRunning) { const now = Date.now(); const totalSeconds = Math.floor((now - stopwatchStartTime + stopwatchElapsedTime) / 1000); stopwatchDisplay.textContent = formatStopwatchTime(totalSeconds); } }
    function startStopwatch() { if (!stopwatchIsRunning) { stopwatchStartTime = Date.now(); stopwatchTimer = setInterval(updateStopwatchDisplay, 1000); stopwatchIsRunning = true; startBtn.disabled = true; pauseBtn.disabled = false; } }
    function pauseStopwatch() { if (stopwatchIsRunning) { clearInterval(stopwatchTimer); const now = Date.now(); stopwatchElapsedTime += now - stopwatchStartTime; stopwatchIsRunning = false; startBtn.disabled = false; pauseBtn.disabled = true; } }
    function stopStopwatch() { clearInterval(stopwatchTimer); stopwatchIsRunning = false; stopwatchStartTime = 0; stopwatchElapsedTime = 0; stopwatchDisplay.textContent = '00:00'; startBtn.disabled = false; pauseBtn.disabled = true; }
    startBtn.addEventListener('click', startStopwatch);
    pauseBtn.addEventListener('click', pauseStopwatch);
    stopBtn.addEventListener('click', stopStopwatch);
    document.addEventListener('DOMContentLoaded', () => { pauseBtn.disabled = true; });
    document.addEventListener('visibilitychange', () => { if (!document.hidden && stopwatchIsRunning) { updateStopwatchDisplay(); } });
    document.addEventListener('DOMContentLoaded', function() {
        const stopwatchWrapper = document.getElementById('stopwatch-wrapper'); const stopwatchContainer = document.getElementById('stopwatch-container'); const wrapperHeight = stopwatchWrapper.offsetHeight; stopwatchWrapper.style.minHeight = `${wrapperHeight}px`;
        window.addEventListener('scroll', function() { if (stopwatchWrapper.getBoundingClientRect().top <= 0) { stopwatchContainer.classList.add('stopwatch-sticky'); } else { stopwatchContainer.classList.remove('stopwatch-sticky'); } });
    });

    document.getElementById('workout-form').addEventListener('keydown', function(event) {
        if (event.key === 'Enter' || event.keyCode === 13) {
            const currentInput = event.target;
            if (currentInput.tagName.toLowerCase() !== 'input') { return; }
            event.preventDefault();
            const inputs = Array.from(document.querySelectorAll('#workout-section input:not([disabled])'));
            const currentIndex = inputs.indexOf(currentInput);
            const nextIndex = currentIndex + 1;
            if (nextIndex < inputs.length) {
                inputs[nextIndex].focus();
                inputs[nextIndex].select();
            } else {
                currentInput.blur();
            }
        }
    });
</script>
{% endblock %}